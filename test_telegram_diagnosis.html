<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram 诊断工具 - AIStorm</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.danger { background: #dc3545; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        .step {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196f3;
            margin: 10px 0;
        }
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .status-item {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .status-ok { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status-warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>🤖 Telegram Bot 诊断工具</h1>
    
    <div class="section">
        <h2>📊 Telegram 功能状态</h2>
        <div class="info result">
            <strong>✅ Telegram 功能已完全实现！</strong>
            <br><br>实现的功能包括：
            <br>• 支付成功通知 (OxaPay Webhook)
            <br>• 订单创建通知
            <br>• 支付失败通知
            <br>• 订单状态更新通知
            <br>• 配置检查和测试接口
            <br><br><strong>如果收不到通知，通常是配置问题，而不是代码问题。</strong>
        </div>
        
        <button class="button" onclick="checkTelegramStatus()">检查 Telegram 状态</button>
        <div id="statusResult" class="result"></div>
    </div>

    <div class="section">
        <h2>🔧 配置检查</h2>
        <p>检查后端配置是否正确：</p>
        <button class="button" onclick="checkConfiguration()">检查配置</button>
        <div id="configResult" class="result"></div>
    </div>

    <div class="section">
        <h2>📨 发送测试消息</h2>
        <p>测试 Telegram Bot 是否能正常发送消息：</p>
        <div style="margin: 10px 0;">
            <button class="button" onclick="sendTestMessage('test')">发送基础测试消息</button>
            <button class="button warning" onclick="sendTestMessage('config')">发送配置信息</button>
            <button class="button success" onclick="sendTestMessage('payment')">模拟支付通知</button>
        </div>
        <div id="testResult" class="result"></div>
    </div>

    <div class="section">
        <h2>🔍 问题诊断指南</h2>
        
        <div class="step">
            <h4>步骤 1: 验证 Bot Token</h4>
            <p>确保您的 Bot Token 正确且有效。</p>
            <div class="code">
# 检查方法：
curl -X GET "https://api.telegram.org/bot YOUR_BOT_TOKEN/getMe"

# 正确响应示例：
{
  "ok": true,
  "result": {
    "id": 123456789,
    "is_bot": true,
    "first_name": "Your Bot Name",
    "username": "your_bot_username"
  }
}
            </div>
        </div>

        <div class="step">
            <h4>步骤 2: 验证 Chat ID</h4>
            <p>确保 Chat ID 正确，可以是个人聊天或群组 ID。</p>
            <div class="code">
# 获取 Chat ID 的方法：
# 1. 向 Bot 发送消息 /start
# 2. 访问: https://api.telegram.org/bot YOUR_BOT_TOKEN/getUpdates
# 3. 在响应中找到 "chat": {"id": -123456789}

# 群组 ID 通常是负数
# 个人聊天 ID 通常是正数
            </div>
        </div>

        <div class="step">
            <h4>步骤 3: 环境变量配置</h4>
            <p>确保在服务器上正确设置了环境变量。</p>
            <div class="code">
# 在 .env 文件中或系统环境变量中设置：
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=-1001234567890
OXAPAY_SECRET_KEY=your_oxapay_secret_key

# 检查是否生效：
echo $TELEGRAM_BOT_TOKEN
echo $TELEGRAM_CHAT_ID
echo $OXAPAY_SECRET_KEY
            </div>
        </div>

        <div class="step">
            <h4>步骤 4: 权限检查</h4>
            <p>确保 Bot 有发送消息的权限。</p>
            <ul>
                <li>✅ Bot 必须在群组中（如果使用群组 ID）</li>
                <li>✅ Bot 必须有发送消息权限</li>
                <li>✅ 群组设置允许 Bot 发送消息</li>
                <li>✅ 您已经与 Bot 开始过对话（如果是私聊）</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>🚨 常见问题和解决方案</h2>
        
        <div class="warning result">
            <strong>问题 1: 收不到任何通知</strong>
            <br>• 检查环境变量是否正确设置
            <br>• 验证 Bot Token 和 Chat ID 是否有效
            <br>• 确保 Bot 已添加到群组或已开始私聊
            <br>• 检查服务器网络是否能访问 Telegram API
        </div>

        <div class="warning result">
            <strong>问题 2: 测试消息可以收到，但支付通知收不到</strong>
            <br>• 检查 OxaPay Webhook URL 是否正确配置
            <br>• 验证 OxaPay 账户的 Webhook 设置
            <br>• 查看服务器日志是否有错误信息
            <br>• 确认订单状态是否正确更新
        </div>

        <div class="warning result">
            <strong>问题 3: 间歇性收不到通知</strong>
            <br>• 检查 Telegram API 速率限制
            <br>• 验证服务器稳定性和网络连接
            <br>• 查看是否有重复消息被过滤
            <br>• 检查消息格式是否正确
        </div>
    </div>

    <div class="section">
        <h2>📝 手动测试步骤</h2>
        <ol>
            <li><strong>检查配置</strong>：点击"检查配置"按钮</li>
            <li><strong>发送测试消息</strong>：点击"发送基础测试消息"</li>
            <li><strong>创建测试订单</strong>：访问 <code>test_invoice_api.html</code> 创建测试订单</li>
            <li><strong>触发支付通知</strong>：完成支付流程查看是否收到通知</li>
            <li><strong>检查日志</strong>：查看服务器后端日志输出</li>
        </ol>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';

        async function checkTelegramStatus() {
            const result = document.getElementById('statusResult');
            try {
                result.textContent = '正在检查 Telegram 状态...';
                
                const response = await fetch(`${API_BASE}/test-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'config' })
                });
                
                const data = await response.json();
                
                let statusHtml = '<div class="status-grid">';
                statusHtml += `<div class="status-item ${data.bot_configured ? 'status-ok' : 'status-error'}">`;
                statusHtml += `<strong>Bot 配置</strong><br>${data.bot_configured ? '✅ 已配置' : '❌ 未配置'}`;
                statusHtml += '</div>';
                
                statusHtml += `<div class="status-item ${data.chat_id_configured ? 'status-ok' : 'status-error'}">`;
                statusHtml += `<strong>Chat ID</strong><br>${data.chat_id_configured ? '✅ 已配置' : '❌ 未配置'}`;
                statusHtml += '</div>';
                
                statusHtml += `<div class="status-item ${data.success ? 'status-ok' : 'status-error'}">`;
                statusHtml += `<strong>发送测试</strong><br>${data.success ? '✅ 成功' : '❌ 失败'}`;
                statusHtml += '</div>';
                statusHtml += '</div>';
                
                statusHtml += `\n\n详细信息:\n${JSON.stringify(data, null, 2)}`;
                
                result.innerHTML = statusHtml;
                result.className = `result ${data.success ? 'success' : 'error'}`;
                
            } catch (error) {
                result.textContent = `❌ 状态检查失败: ${error.message}`;
                result.className = 'result error';
            }
        }

        async function checkConfiguration() {
            const result = document.getElementById('configResult');
            try {
                result.textContent = '正在检查配置...';
                
                const response = await fetch(`${API_BASE}/test-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type: 'config' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.textContent = `✅ 配置检查完成！\n\n如果您收到了 Telegram 消息，说明配置正确。\n如果没有收到，请检查：\n1. Bot Token 是否正确\n2. Chat ID 是否正确\n3. Bot 是否有发送权限\n\n详细响应:\n${JSON.stringify(data, null, 2)}`;
                    result.className = 'result success';
                } else {
                    result.textContent = `❌ 配置检查发现问题:\n\n${data.message || '未知错误'}\n\n详细响应:\n${JSON.stringify(data, null, 2)}`;
                    result.className = 'result error';
                }
                
            } catch (error) {
                result.textContent = `❌ 配置检查失败: ${error.message}`;
                result.className = 'result error';
            }
        }

        async function sendTestMessage(type) {
            const result = document.getElementById('testResult');
            try {
                result.textContent = `正在发送${type}测试消息...`;
                
                let messageData = { type: type };
                
                if (type === 'payment') {
                    messageData.message = `💰 <b>模拟支付成功通知</b>

📦 <b>产品：</b>ChatGPT Pro 账号
🔢 <b>数量：</b>1 月
💵 <b>金额：</b>$29.99 USDT
📧 <b>邮箱：</b>test@aistorm.art
🆔 <b>订单号：</b><code>order_test_${Date.now()}</code>
📊 <b>状态：</b>支付成功
⏰ <b>时间：</b>${new Date().toLocaleString('zh-CN')}

💳 <b>支付方式：</b>USDT支付
🔍 <b>追踪ID：</b><code>test_track_${Date.now()}</code>

🎉 <b>这是一条测试消息！</b>`;
                }
                
                const response = await fetch(`${API_BASE}/test-telegram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.textContent = `✅ ${type}测试消息发送成功！\n\n请检查您的 Telegram 是否收到消息。\n\n如果收到了，说明 Telegram 配置完全正常！\n如果没收到，请检查 Bot 权限和配置。\n\n服务器响应:\n${JSON.stringify(data, null, 2)}`;
                    result.className = 'result success';
                } else {
                    result.textContent = `❌ 测试消息发送失败:\n\n${data.message || data.error}\n\n请检查：\n1. TELEGRAM_BOT_TOKEN 是否正确\n2. TELEGRAM_CHAT_ID 是否正确\n3. Bot 是否有发送消息权限\n\n服务器响应:\n${JSON.stringify(data, null, 2)}`;
                    result.className = 'result error';
                }
                
            } catch (error) {
                result.textContent = `❌ 测试消息发送异常: ${error.message}`;
                result.className = 'result error';
            }
        }

        // 页面加载提示
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (confirm('Telegram 诊断工具已加载！\n\n这个工具将帮助您：\n✅ 检查 Telegram 配置状态\n✅ 发送测试消息\n✅ 诊断常见问题\n\n是否立即开始检查 Telegram 状态？')) {
                    checkTelegramStatus();
                }
            }, 1000);
        });
    </script>
</body>
</html> 