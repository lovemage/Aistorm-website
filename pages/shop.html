<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIStorm å•†åº— - è´­ä¹°AIè´¦å·æœåŠ¡</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ç»§æ‰¿ç½‘ç«™ä¸»è¦æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0D0F12 0%, #101217 50%, #1A1D24 100%);
            color: #EAEAEA;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation Bar */
        .shop-nav {
            background: rgba(16, 18, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 229, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #00E5FF;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .nav-logo:hover {
            color: #00E5FF;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: #C0C0C0;
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            color: #00E5FF;
        }

        .nav-link.active {
            color: #00E5FF;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .shop-nav {
                position: sticky;
                top: 0;
            }
        }

        /* Header */
        .shop-header {
            background: rgba(16, 18, 23, 0.95);
            padding: 2rem 0;
            border-bottom: 2px solid #00E5FF;
            text-align: center;
            margin-bottom: 3rem;
        }

        .shop-header h1 {
            color: #00E5FF;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }

        .shop-header p {
            color: #C0C0C0;
            font-size: 1.1rem;
            margin: 0.5rem 0 0 0;
        }

        /* è´­ä¹°è¡¨å• */
        .purchase-form {
            background: linear-gradient(145deg, #1A1D24, #101217);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 3rem;
            border: 1px solid rgba(0, 229, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .form-section {
            margin-bottom: 2.5rem;
        }

        .form-section h3 {
            color: #00E5FF;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #00E5FF;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* äº§å“é€‰æ‹© */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .product-option {
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .product-option:hover {
            border-color: rgba(0, 229, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 229, 255, 0.2);
        }

        .product-option.selected {
            border-color: #00E5FF;
            background: rgba(0, 229, 255, 0.1);
        }

        .product-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .product-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            transition: all 0.3s ease;
        }

        .product-option:hover .product-icon {
            border-color: rgba(0, 229, 255, 0.6);
            transform: scale(1.05);
        }

        .product-option.selected .product-icon {
            border-color: #00E5FF;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
        }

        .product-title {
            color: #D400FF;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: #B0B0B0;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .product-price {
            color: #39FF14;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .product-price-rmb {
            color: #00E5FF;
            font-size: 1rem;
        }

        /* æ•°é‡é€‰æ‹© */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .quantity-label {
            color: #C0C0C0;
            font-size: 1.1rem;
            min-width: 80px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            background: rgba(26, 29, 36, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 229, 255, 0.3);
        }

        .quantity-btn {
            background: transparent;
            border: none;
            color: #00E5FF;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .quantity-btn:hover {
            background: rgba(0, 229, 255, 0.2);
        }

        .quantity-btn:disabled {
            color: #666;
            cursor: not-allowed;
        }

        .quantity-input {
            background: transparent;
            border: none;
            color: #EAEAEA;
            text-align: center;
            width: 60px;
            height: 40px;
            font-size: 1.1rem;
        }

        /* æ”¯ä»˜æ–¹å¼é€‰æ‹© */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .payment-option {
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .payment-option:hover {
            border-color: rgba(0, 229, 255, 0.5);
            transform: translateY(-3px);
        }

        .payment-option.selected {
            border-color: #00E5FF;
            background: rgba(0, 229, 255, 0.1);
        }

        .payment-option input[type="radio"] {
            display: none;
        }

        .payment-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .payment-option:hover .payment-icon {
            border-color: rgba(0, 229, 255, 0.6);
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
        }

        .payment-option.selected .payment-icon {
            border-color: #00E5FF;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }

        .usdt-icon {
            background-image: url('../assets/images/USDT.png');
            background-color: #26a17b;
        }

        .alipay-icon {
            background-image: url('../assets/images/alipay.png');
            background-color: #1677ff;
        }

        .payment-title {
            color: #D400FF;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .payment-description {
            color: #B0B0B0;
            font-size: 0.9rem;
        }

        /* é‚®ç®±è¾“å…¥ */
        .email-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid rgba(0, 229, 255, 0.3);
            border-radius: 10px;
            color: #EAEAEA;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #00E5FF;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .email-input::placeholder {
            color: #888;
        }

        /* è®¢å•æ‘˜è¦ */
        .order-summary {
            background: linear-gradient(145deg, #101217, #1A1D24);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(212, 0, 255, 0.3);
            display: none;
        }

        .order-summary.show {
            display: block;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-title {
            color: #D400FF;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .summary-label {
            color: #C0C0C0;
        }

        .summary-value {
            color: #EAEAEA;
            font-weight: bold;
        }

        .total-amount {
            background: rgba(57, 255, 20, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            text-align: center;
            border: 1px solid #39FF14;
        }

        .total-usdt {
            color: #39FF14;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .total-rmb {
            color: #00E5FF;
            font-size: 1.2rem;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00E5FF, #0AA6D8);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 229, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #39FF14, #2ECC40);
            color: #000;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(57, 255, 20, 0.4);
        }

        .btn-disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #666;
            color: #EAEAEA;
        }

        .btn-secondary:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 102, 102, 0.4);
        }

        /* æ”¯ä»˜æŒ‰é’®åŒºåŸŸ */
        .payment-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* å¾®ä¿¡äºŒç»´ç å¼¹çª— */
        .qrcode-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .qrcode-content {
            background: linear-gradient(145deg, #1A1D24, #101217);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #00E5FF;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
        }

        .qrcode-content h3 {
            color: #00E5FF;
            margin-bottom: 1.5rem;
        }

        .qrcode-content img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .purchase-form {
                padding: 2rem;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .payment-actions {
                flex-direction: column;
            }

            .shop-header h1 {
                font-size: 2rem;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 229, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00E5FF;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* äº§å“å›¾æ ‡ */
        .icon-chatgpt { background-image: url('../assets/images/chatgptpro.jpg'); }
        .icon-claude { background-image: url('../assets/images/claudemax.jpg'); }
        .icon-grok { background-image: url('../assets/images/grokpro.jpg'); }
        .icon-cursor { background-image: url('../assets/images/curserpro.jpeg'); }
        .icon-lovable { background-image: url('../assets/images/lovable.png'); }
        .icon-combo { background-image: url('../assets/images/logo.jpeg'); }
        
        /* é»˜è®¤å›¾æ ‡ */
        .icon-default {
            background: linear-gradient(135deg, #D400FF, #00E5FF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        /* å†…è”æ”¯ä»˜è¯¦æƒ…æ ·å¼ */
        .payment-details-section {
            margin-top: 3rem;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: rgba(26, 29, 36, 0.6);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .info-card label {
            display: block;
            color: #C0C0C0;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .info-card span {
            color: #00E5FF;
            font-weight: bold;
            font-size: 1rem;
        }

        .qr-payment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .qr-code-section, .address-section {
            text-align: center;
        }

        /* å½“æ˜¾ç¤ºiframeæ—¶ï¼Œè°ƒæ•´å¸ƒå±€ */
        .qr-code-section.iframe-mode {
            grid-column: 1 / -1;
        }

        .qr-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        /* å½“åŒ…å«iframeæ—¶ï¼Œç§»é™¤èƒŒæ™¯å’Œpadding */
        .qr-container.iframe-container {
            background: transparent;
            padding: 0;
            min-height: auto;
        }

        .loading-placeholder {
            color: #666;
            text-align: center;
        }

        /* iframe æ”¯ä»˜é¡µé¢åµŒå…¥æ ·å¼ */
        .payment-iframe-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(0, 229, 255, 0.3);
        }

        .payment-iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 8px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .iframe-header {
            background: linear-gradient(135deg, #00E5FF, #0091EA);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .iframe-fallback {
            text-align: center;
            padding: 20px;
            background: rgba(26, 29, 36, 0.8);
            border-radius: 10px;
            margin-top: 10px;
        }

        /* ç§»åŠ¨ç«¯iframeé€‚é… */
        @media (max-width: 768px) {
            .payment-iframe {
                height: 700px;
            }
            
            .qr-payment-container {
                grid-template-columns: 1fr;
            }
            
            .payment-iframe-container {
                grid-column: 1 / -1;
                margin-bottom: 1rem;
            }
        }

        .copy-button {
            background: #00E5FF;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .copy-button:hover {
            background: #00B8CC;
        }

        .payment-status {
            color: #FFC107;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .qr-payment-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .payment-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="shop-nav">
        <div class="nav-content">
            <a href="../index.html" class="nav-logo">
                <img src="../assets/images/logo.jpeg" alt="AIStorm Logo" style="width: 40px; height: 40px; border-radius: 8px;">
                AIStorm
            </a>
            <div class="nav-links">
                <a href="../index.html" class="nav-link">é¦–é¡µ</a>
                <a href="shop.html" class="nav-link active">å•†åº—</a>
                <a href="#contact" class="nav-link">è”ç³»æˆ‘ä»¬</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="shop-header">
        <div class="container">
            <h1>AIStorm å•†åº—</h1>
            <p>é€‰æ‹©æ‚¨éœ€è¦çš„AIè´¦å·æœåŠ¡ï¼Œäº«å—æ™ºèƒ½ç”Ÿæ´»</p>
        </div>
    </header>

    <div class="container">
        <form class="purchase-form" id="purchaseForm">
            <!-- æ­¥éª¤1: é€‰æ‹©äº§å“ -->
            <div class="form-section">
                <h3>
                    <span class="step-number">1</span>
                    é€‰æ‹©AIäº§å“
                </h3>
                <div class="product-grid" id="productGrid">
                    <!-- äº§å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div style="text-align: center; color: #666; grid-column: 1 / -1;">
                        <div class="loading"></div>
                        æ­£åœ¨åŠ è½½äº§å“ä¿¡æ¯...
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: é€‰æ‹©æ•°é‡ -->
            <div class="form-section">
                <h3>
                    <span class="step-number">2</span>
                    é€‰æ‹©è´­ä¹°æ•°é‡
                </h3>
                <div class="quantity-selector">
                    <span class="quantity-label">æ•°é‡:</span>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-btn" id="decreaseBtn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="5" readonly>
                        <button type="button" class="quantity-btn" id="increaseBtn" onclick="changeQuantity(1)">+</button>
                    </div>
                    <span style="color: #888; font-size: 0.9rem;">(æœ€å¤š5ä¸ª)</span>
                </div>
            </div>

            <!-- æ­¥éª¤3: é€‰æ‹©æ”¯ä»˜æ–¹å¼ -->
            <div class="form-section">
                <h3>
                    <span class="step-number">3</span>
                    é€‰æ‹©æ”¯ä»˜æ–¹å¼
                </h3>
                <div class="payment-methods">
                    <label class="payment-option" for="usdt">
                        <input type="radio" id="usdt" name="paymentMethod" value="usdt">
                        <div class="payment-icon usdt-icon"></div>
                        <div class="payment-title">USDT åŠ å¯†æ”¯ä»˜</div>
                        <div class="payment-description">Secure payment via Oxapay, generate Order.</div>
                    </label>
                    <label class="payment-option" for="alipay">
                        <input type="radio" id="alipay" name="paymentMethod" value="alipay">
                        <div class="payment-icon alipay-icon"></div>
                        <div class="payment-title">æ”¯ä»˜å®å£ä»¤çº¢åŒ…</div>
                        <div class="payment-description">å¾®ä¿¡æ‰«ç è”ç³»å®¢æœ</div>
                    </label>
                </div>
            </div>

            <!-- æ­¥éª¤4: è”ç³»é‚®ç®± -->
            <div class="form-section">
                <h3>
                    <span class="step-number">4</span>
                    è”ç³»é‚®ç®±
                </h3>
                <input type="email" class="email-input" id="emailInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required>
                <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">æˆ‘ä»¬å°†é€šè¿‡æ­¤é‚®ç®±å‘æ‚¨å‘é€è´¦å·ä¿¡æ¯</p>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div style="text-align: center; margin-top: 2rem;">
                <button type="button" class="btn btn-primary" id="generateOrderBtn" onclick="generateOrder()">
                    ç”Ÿæˆè®¢å•
                </button>
            </div>
        </form>

        <!-- è®¢å•æ‘˜è¦ -->
        <div class="order-summary" id="orderSummary">
            <h3 class="summary-title">è®¢å•æ‘˜è¦</h3>
            <div class="summary-item">
                <span class="summary-label">é€‰æ‹©äº§å“:</span>
                <span class="summary-value" id="summaryProduct">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">è´­ä¹°æ•°é‡:</span>
                <span class="summary-value" id="summaryQuantity">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ”¯ä»˜æ–¹å¼:</span>
                <span class="summary-value" id="summaryPayment">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">è”ç³»é‚®ç®±:</span>
                <span class="summary-value" id="summaryEmail">-</span>
            </div>
            
            <div class="total-amount">
                <div class="total-usdt" id="totalUSDT">$0 USDT</div>
                <div class="total-rmb" id="totalRMB">â‰ˆ Â¥0</div>
            </div>

            <div class="payment-actions">
                <button type="button" class="btn btn-success" id="usdtPayBtn" onclick="processUSDTPayment()" style="display: none;">
                    å‰å¾€OxaPayæ”¯ä»˜
                </button>
                <button type="button" class="btn btn-success" id="alipayPayBtn" onclick="processAlipayPayment()" style="display: none;">
                    è”ç³»å®¢æœæ”¯ä»˜
                </button>
                <button type="button" class="btn btn-primary" onclick="editOrder()">
                    ä¿®æ”¹è®¢å•
                </button>
            </div>
        </div>
    </div>

    <!-- å†…è”æ”¯ä»˜è¯¦æƒ…åŒºåŸŸ -->
    <div class="payment-details-section" id="paymentDetailsSection" style="display: none;">
        <div class="purchase-form">
            <h3 style="color: #00E5FF; text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-credit-card" style="margin-right: 10px;"></i>
                USDT æ”¯ä»˜è¯¦æƒ…
            </h3>
            
            <!-- è®¢å•ä¿¡æ¯ -->
            <div class="payment-info-grid" style="margin-bottom: 2rem;">
                <div class="info-card">
                    <label>è®¢å•å·:</label>
                    <span id="paymentOrderId">-</span>
                </div>
                <div class="info-card">
                    <label>å‘ç¥¨ID:</label>
                    <span id="paymentInvoiceId">-</span>
                </div>
                <div class="info-card">
                    <label>æ”¯ä»˜é‡‘é¢:</label>
                    <span id="paymentAmount">-</span>
                </div>
                <div class="info-card">
                    <label>æ”¯ä»˜ç½‘ç»œ:</label>
                    <span id="paymentNetwork">TRC20</span>
                </div>
            </div>

            <!-- äºŒç»´ç å’Œåœ°å€ -->
            <div class="qr-payment-container">
                <div class="qr-code-section">
                    <h4 style="color: #00E5FF; text-align: center;">æ‰«ææ”¯ä»˜</h4>
                    <div class="qr-container">
                        <img id="paymentQRCode" src="" alt="æ”¯ä»˜äºŒç»´ç " style="max-width: 200px; width: 100%; border-radius: 10px; display: none;">
                        <div id="qrLoading" class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>æ­£åœ¨ç”Ÿæˆæ”¯ä»˜äºŒç»´ç ...</p>
                        </div>
                    </div>
                </div>
                
                <div class="address-section">
                    <h4 style="color: #00E5FF;">é’±åŒ…åœ°å€</h4>
                    <div class="address-input-group">
                        <input type="text" id="paymentAddress" readonly placeholder="æ­£åœ¨è·å–æ”¯ä»˜åœ°å€..." 
                               style="font-family: monospace; font-size: 0.9rem; background: rgba(26, 29, 36, 0.8); 
                                      border: 1px solid rgba(0, 229, 255, 0.3); color: #EAEAEA; padding: 10px; 
                                      border-radius: 8px; width: 100%; margin-bottom: 10px;">
                        <button onclick="copyPaymentAddress()" class="copy-button">
                            <i class="fas fa-copy"></i> å¤åˆ¶åœ°å€
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ”¯ä»˜è¯´æ˜ -->
            <div class="payment-instructions" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); 
                                                   border-radius: 10px; padding: 1.5rem; margin: 2rem 0;">
                <h5 style="color: #FFC107; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> é‡è¦æé†’
                </h5>
                <ul style="color: #C0C0C0; margin: 0; padding-left: 1.5rem;">
                    <li>è¯·ç¡®ä¿ä½¿ç”¨ <strong style="color: #00E5FF;">TRC20ç½‘ç»œ</strong> è½¬è´¦USDT</li>
                    <li>è½¬è´¦é‡‘é¢å¿…é¡» <strong style="color: #00E5FF;">å®Œå…¨åŒ¹é…</strong> ä¸Šè¿°æ˜¾ç¤ºé‡‘é¢</li>
                    <li>æ”¯ä»˜å®Œæˆåçº¦ <strong style="color: #00E5FF;">5åˆ†é’Ÿ</strong> è‡ªåŠ¨ç¡®è®¤</li>
                    <li>å¦‚é‡é—®é¢˜è¯·è”ç³»:</li>
                </ul>
                <div style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <div style="color: #C0C0C0; margin-bottom: 0.3rem;">
                        ğŸ“± äººå·¥å®¢æœTelegram: <strong style="color: #00E5FF;">@aistorm2025</strong>
                    </div>
                    <div style="color: #C0C0C0;">
                        ğŸ’¬ äººå·¥å®¢æœå¾®ä¿¡: <strong style="color: #00E5FF;">aistorm2024</strong>
                    </div>
                </div>
            </div>

            <!-- æ”¯ä»˜çŠ¶æ€å’Œæ“ä½œ -->
            <div class="payment-actions-inline" style="text-align: center;">
                <div class="payment-status" id="paymentStatus" style="margin-bottom: 1rem;">
                    <span class="status-indicator" style="display: inline-block; width: 12px; height: 12px; 
                                                        border-radius: 50%; background: #FFC107; margin-right: 8px;"></span>
                    ç­‰å¾…æ”¯ä»˜...
                </div>
                <button onclick="checkInlinePaymentStatus()" class="btn btn-primary" style="margin-right: 10px;">
                    <i class="fas fa-sync"></i> æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                </button>
                <button onclick="hidePaymentDetails()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> å–æ¶ˆæ”¯ä»˜
                </button>
            </div>
        </div>
    </div>

    <!-- å¾®ä¿¡äºŒç»´ç å¼¹çª— -->
    <div class="qrcode-modal" id="qrcodeModal">
        <div class="qrcode-content">
            <h3>å¾®ä¿¡æ‰«ç è”ç³»å®¢æœ</h3>
            <img src="../assets/images/wechat_qrcode.jpeg" alt="å¾®ä¿¡å®¢æœäºŒç»´ç " onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: #888; padding: 2rem;">å¾®ä¿¡äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥<br>è¯·ç›´æ¥æ·»åŠ å¾®ä¿¡: aistorm2024</div>
            <p style="color: #C0C0C0; margin: 1rem 0;">æ·»åŠ å®¢æœå¾®ä¿¡: <strong>aistorm2024</strong></p>
            <p style="color: #888; font-size: 0.9rem;">å®¢æœå°†ååŠ©æ‚¨å®Œæˆæ”¯ä»˜å®å£ä»¤çº¢åŒ…æ”¯ä»˜</p>
            <button class="close-modal" onclick="closeQRCodeModal()">å…³é—­</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JSæ–‡ä»¶ -->
    <script src="../assets/js/api-config.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let products = [];
        let selectedProduct = null;
        let quantity = 1;
        let paymentMethod = null;
        let usdtToCnyRate = 8.0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            initializeEventListeners();
        });

        // åŠ è½½äº§å“æ•°æ®
        async function loadProducts() {
            try {
                // è·å–æ±‡ç‡è®¾ç½®
                await loadSiteSettings();
                
                // åŠ è½½äº§å“
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl}/products`);
                
                if (response.ok) {
                    products = await response.json();
                    console.log('âœ… äº§å“æ•°æ®åŠ è½½æˆåŠŸ:', products);
                    renderProducts();
                } else {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½äº§å“å¤±è´¥:', error);
                // ä½¿ç”¨é™æ€æ•°æ®ä½œä¸ºåå¤‡
                products = getStaticProducts();
                renderProducts();
            }
        }

        // åŠ è½½ç«™ç‚¹è®¾ç½®è·å–æ±‡ç‡
        async function loadSiteSettings() {
            try {
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl.replace('/api', '')}/api/settings`);
                
                if (response.ok) {
                    const settings = await response.json();
                    if (settings.usdt_to_cny_rate) {
                        usdtToCnyRate = parseFloat(settings.usdt_to_cny_rate);
                        console.log('ğŸ’± è·å–æ±‡ç‡è®¾ç½®:', usdtToCnyRate);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ è·å–æ±‡ç‡è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ±‡ç‡:', usdtToCnyRate);
            }
        }

        // é™æ€äº§å“æ•°æ®ä½œä¸ºåå¤‡
        function getStaticProducts() {
            return [
                {
                    name: 'AIé£æš´ç»„åˆå¥—é¤',
                    slug: 'ai-storm-combo',
                    short_description: 'ChatGPT Pro + Super Grok + Claude Max 5x ä¸‰åˆä¸€è¶…å€¼å¥—é¤',
                    price_usd: 200,
                    price_unit: 'æœˆ',
                    in_stock: true
                },
                {
                    name: 'ChatGPT Pro',
                    slug: 'chatgpt-pro',
                    short_description: 'OpenAI å®˜æ–¹ Pro ç‰ˆæœ¬ï¼Œæ— é™åˆ¶ GPT-4 Turbo',
                    price_usd: 130,
                    price_unit: 'æœˆ',
                    in_stock: true
                },
                {
                    name: 'Claude Max 5x',
                    slug: 'claude-max-5x',
                    short_description: 'Anthropic Claude-3 Opusï¼Œ5å€ä½¿ç”¨é‡',
                    price_usd: 75,
                    price_unit: 'æœˆ',
                    in_stock: true
                },
                {
                    name: 'Super Grok',
                    slug: 'super-grok',
                    short_description: 'xAI å‡ºå“ï¼ŒXå¹³å°æ·±åº¦æ•´åˆ',
                    price_usd: 20,
                    price_unit: 'æœˆ',
                    in_stock: true
                },
                {
                    name: 'Cursor Pro',
                    slug: 'cursor-pro',
                    short_description: 'AI-First Code Editorï¼ŒGPT-4 Turbo é©±åŠ¨',
                    price_usd: 12,
                    price_unit: 'æœˆ',
                    in_stock: true
                },
                {
                    name: 'Lovable Pro 200 Credit',
                    slug: 'lovable-pro-200-credit',
                    short_description: 'AI å…¨æ ˆåº”ç”¨å¼€å‘å¹³å°ï¼Œå¿«é€ŸåŸå‹ä¸éƒ¨ç½²',
                    price_usd: 35,
                    price_unit: '200 Credit',
                    in_stock: true
                }
            ];
        }

        // æ¸²æŸ“äº§å“åˆ—è¡¨
        function renderProducts() {
            const productGrid = document.getElementById('productGrid');
            
            if (products.length === 0) {
                productGrid.innerHTML = '<div style="text-align: center; color: #888; grid-column: 1 / -1;">æš‚æ— å¯ç”¨äº§å“</div>';
                return;
            }

            productGrid.innerHTML = products.map(product => {
                // æ ¹æ®äº§å“slugç¡®å®šå›¾æ ‡ç±»
                let iconClass = 'icon-default';
                if (product.slug.includes('chatgpt')) iconClass = 'icon-chatgpt';
                else if (product.slug.includes('claude')) iconClass = 'icon-claude';
                else if (product.slug.includes('grok')) iconClass = 'icon-grok';
                else if (product.slug.includes('cursor')) iconClass = 'icon-cursor';
                else if (product.slug.includes('lovable')) iconClass = 'icon-lovable';
                else if (product.slug.includes('combo') || product.slug.includes('storm')) iconClass = 'icon-combo';
                
                // å¦‚æœæ˜¯é»˜è®¤å›¾æ ‡ï¼Œæ˜¾ç¤ºäº§å“åé¦–å­—æ¯
                const iconContent = iconClass === 'icon-default' ? 
                    `<div class="product-icon ${iconClass}">${product.name.charAt(0)}</div>` :
                    `<div class="product-icon ${iconClass}"></div>`;

                return `
                    <label class="product-option" for="product_${product.slug}">
                        <input type="radio" id="product_${product.slug}" name="product" value="${product.slug}" onchange="selectProduct('${product.slug}')">
                        ${iconContent}
                        <div class="product-title">${product.name}</div>
                        <div class="product-description">${product.short_description || product.description || ''}</div>
                        <div class="product-price">$${product.price_usd} USDT/${product.price_unit}</div>
                        <div class="product-price-rmb">â‰ˆ Â¥${Math.round(product.price_usd * usdtToCnyRate)}/${product.price_unit}</div>
                        ${!product.in_stock ? '<div style="color: #FF5252; font-size: 0.9rem; margin-top: 0.5rem;">æš‚æ—¶ç¼ºè´§</div>' : ''}
                    </label>
                `;
            }).join('');
        }

        // é€‰æ‹©äº§å“
        function selectProduct(slug) {
            selectedProduct = products.find(p => p.slug === slug);
            
            // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.product-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`label[for="product_${slug}"]`).classList.add('selected');
            
            console.log('é€‰æ‹©äº§å“:', selectedProduct);
        }

        // ä¿®æ”¹æ•°é‡
        function changeQuantity(delta) {
            const input = document.getElementById('quantityInput');
            const newValue = parseInt(input.value) + delta;
            
            if (newValue >= 1 && newValue <= 5) {
                input.value = newValue;
                quantity = newValue;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('decreaseBtn').disabled = newValue <= 1;
                document.getElementById('increaseBtn').disabled = newValue >= 5;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æ”¯ä»˜æ–¹å¼é€‰æ‹©
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    paymentMethod = this.value;
                    
                    // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.payment-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    this.closest('.payment-option').classList.add('selected');
                    
                    console.log('é€‰æ‹©æ”¯ä»˜æ–¹å¼:', paymentMethod);
                });
            });

            // æ•°é‡è¾“å…¥æ¡†ç›‘å¬
            document.getElementById('quantityInput').addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value >= 1 && value <= 5) {
                    quantity = value;
                    document.getElementById('decreaseBtn').disabled = value <= 1;
                    document.getElementById('increaseBtn').disabled = value >= 5;
                }
            });
        }

        // ç”Ÿæˆè®¢å•
        function generateOrder() {
            // éªŒè¯è¡¨å•
            const email = document.getElementById('emailInput').value;
            
            if (!selectedProduct) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªAIäº§å“');
                return;
            }
            
            if (!paymentMethod) {
                alert('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
                return;
            }
            
            if (!email || !isValidEmail(email)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            // è®¡ç®—æ€»ä»·
            const totalUSDT = selectedProduct.price_usd * quantity;
            const totalRMB = Math.round(totalUSDT * usdtToCnyRate);

            // æ›´æ–°è®¢å•æ‘˜è¦
            document.getElementById('summaryProduct').textContent = `${selectedProduct.name} Ã— ${quantity}`;
            document.getElementById('summaryQuantity').textContent = `${quantity} ä¸ª`;
            document.getElementById('summaryPayment').textContent = paymentMethod === 'usdt' ? 'USDTæ”¯ä»˜' : 'æ”¯ä»˜å®å£ä»¤çº¢åŒ…';
            document.getElementById('summaryEmail').textContent = email;
            document.getElementById('totalUSDT').textContent = `$${totalUSDT} USDT`;
            document.getElementById('totalRMB').textContent = `â‰ˆ Â¥${totalRMB}`;

            // æ˜¾ç¤ºå¯¹åº”çš„æ”¯ä»˜æŒ‰é’®
            document.getElementById('usdtPayBtn').style.display = paymentMethod === 'usdt' ? 'inline-block' : 'none';
            document.getElementById('alipayPayBtn').style.display = paymentMethod === 'alipay' ? 'inline-block' : 'none';

            // æ˜¾ç¤ºè®¢å•æ‘˜è¦
            document.getElementById('orderSummary').classList.add('show');
            
            // æ»šåŠ¨åˆ°è®¢å•æ‘˜è¦
            document.getElementById('orderSummary').scrollIntoView({ behavior: 'smooth' });
        }

        // éªŒè¯é‚®ç®±æ ¼å¼
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // å¤„ç†USDTæ”¯ä»˜
        function processUSDTPayment() {
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = true;
            usdtBtn.innerHTML = '<div class="loading"></div>å¤„ç†ä¸­...';
            
            createOrderAndPay();
        }

        // åˆ›å»ºè®¢å•å¹¶å¤„ç†æ”¯ä»˜
        async function createOrderAndPay() {
            try {
                const email = document.getElementById('emailInput').value;
                
                console.log('ğŸš€ å¼€å§‹åˆ›å»ºè®¢å•...', {
                    product: selectedProduct.slug,
                    quantity: quantity,
                    email: email
                });
                
                // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè®¢å•
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const orderPayload = {
                    customer_email: email,
                    product_slug: selectedProduct.slug,
                    quantity: quantity
                };
                
                console.log('ğŸ“¤ å‘é€è®¢å•æ•°æ®:', orderPayload);
                
                const createOrderResponse = await fetch(`${apiBaseUrl}/create-order`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(orderPayload)
                });
                
                console.log('ğŸ“¥ è®¢å•åˆ›å»ºå“åº”çŠ¶æ€:', createOrderResponse.status);
                
                if (!createOrderResponse.ok) {
                    const errorText = await createOrderResponse.text();
                    console.error('âŒ è®¢å•åˆ›å»ºå¤±è´¥å“åº”:', errorText);
                    
                    // å°è¯•è§£æJSONé”™è¯¯
                    let errorMessage = `è®¢å•åˆ›å»ºå¤±è´¥ (${createOrderResponse.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const orderData = await createOrderResponse.json();
                console.log('âœ… è®¢å•åˆ›å»ºå“åº”æ•°æ®:', orderData);
                
                if (!orderData.success) {
                    throw new Error(orderData.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
                }
                
                console.log('âœ… è®¢å•åˆ›å»ºæˆåŠŸ:', orderData);
                
                // ä½¿ç”¨åç«¯è¿”å›çš„è®¢å•ID
                const finalOrderId = orderData.order_id;
                
                // ç¬¬äºŒæ­¥ï¼šç”ŸæˆOxaPayæ”¯ä»˜é“¾æ¥
                const paymentPayload = {
                    orderId: finalOrderId
                };
                
                console.log('ğŸ“¤ å‘é€æ”¯ä»˜è¯·æ±‚:', paymentPayload);
                
                const oxapayResponse = await fetch(`${apiBaseUrl}/oxapay-payment`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(paymentPayload)
                });
                
                console.log('ğŸ“¥ æ”¯ä»˜å“åº”çŠ¶æ€:', oxapayResponse.status);
                
                if (!oxapayResponse.ok) {
                    const errorText = await oxapayResponse.text();
                    console.error('âŒ æ”¯ä»˜è¯·æ±‚å¤±è´¥å“åº”:', errorText);
                    
                    // å°è¯•è§£æJSONé”™è¯¯
                    let errorMessage = `æ”¯ä»˜è¯·æ±‚å¤±è´¥ (${oxapayResponse.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const payData = await oxapayResponse.json();
                console.log('âœ… æ”¯ä»˜å“åº”æ•°æ®:', payData);
                
                if (!payData.success) {
                    // æ”¹è¿›é”™è¯¯å¤„ç†ï¼šä¸ºå¸¸è§é”™è¯¯æä¾›æ›´å‹å¥½çš„æç¤º
                    let userFriendlyError = payData.error || 'ç”Ÿæˆæ”¯ä»˜é“¾æ¥å¤±è´¥';
                    
                    // å¦‚æœæ˜¯APIå¯†é’¥ç›¸å…³é”™è¯¯ï¼Œä½†åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                    if (userFriendlyError.includes('APIå¯†é’¥æœªé…ç½®') || userFriendlyError.includes('å¯†é’¥æ— æ•ˆ')) {
                        userFriendlyError = 'æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ';
                    }
                    
                    throw new Error(userFriendlyError);
                }
                
                console.log('âœ… æ”¯ä»˜é“¾æ¥ç”ŸæˆæˆåŠŸ:', payData);
                
                // ç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºå†…è”æ”¯ä»˜è¯¦æƒ…ï¼ˆè€Œä¸æ˜¯è·³è½¬é¡µé¢ï¼‰
                if (payData.payLink || payData.qrCode || payData.payAddress) {
                    // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸåˆ›å»ºçš„æç¤º
                    alert(`è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·: ${finalOrderId}\nè¯·åœ¨ä¸‹æ–¹å®ŒæˆUSDTæ”¯ä»˜ã€‚`);
                    
                    // æ˜¾ç¤ºå†…è”æ”¯ä»˜è¯¦æƒ…
                    showInlinePaymentDetails(finalOrderId, payData);
                    
                    // å¯åŠ¨è®¢å•çŠ¶æ€è½®è¯¢
                    startOrderStatusPolling(finalOrderId);
                } else {
                    throw new Error('æ”¯ä»˜é“¾æ¥ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ æ”¯ä»˜å¤„ç†é”™è¯¯:', error);
                alert(`æ”¯ä»˜å¤„ç†å¤±è´¥: ${error.message}\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœã€‚`);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const usdtBtn = document.getElementById('usdtPayBtn');
                usdtBtn.disabled = false;
                usdtBtn.innerHTML = 'å‰å¾€OxaPayæ”¯ä»˜';
            }
        }

        // è½®è¯¢è®¢å•çŠ¶æ€
        function startOrderStatusPolling(orderId) {
            const maxAttempts = 30; // æœ€å¤šè½®è¯¢30æ¬¡ï¼ˆ5åˆ†é’Ÿï¼‰
            let attempts = 0;
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                    const response = await fetch(`${apiBaseUrl}/order-status/${orderId}`);
                    const data = await response.json();
                    
                    if (data.success && data.order) {
                        const order = data.order;
                        
                        if (order.payment_status === 'completed') {
                            clearInterval(pollInterval);
                            showPaymentSuccess(order);
                            return;
                        } else if (order.payment_status === 'failed') {
                            clearInterval(pollInterval);
                            showPaymentFailure(order);
                            return;
                        }
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€æ˜¾ç¤ºè½®è¯¢è¿›åº¦
                    const usdtBtn = document.getElementById('usdtPayBtn');
                    usdtBtn.innerHTML = `<div class="loading"></div>ç­‰å¾…æ”¯ä»˜ç¡®è®¤ (${attempts}/${maxAttempts})`;
                    
                } catch (error) {
                    console.error('è½®è¯¢è®¢å•çŠ¶æ€é”™è¯¯:', error);
                }
                
                // è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°
                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    showPaymentTimeout(orderId);
                }
            }, 10000); // æ¯10ç§’è½®è¯¢ä¸€æ¬¡
        }

        // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
        function showPaymentSuccess(order) {
            alert(`ğŸ‰ æ”¯ä»˜æˆåŠŸï¼\n\nè®¢å•å·: ${order.order_id}\näº§å“: ${order.product_name} Ã— ${order.quantity}\næ€»ä»·: $${order.total_amount_usd} USDT\n\næˆ‘ä»¬ä¼šå°½å¿«å°†è´¦å·ä¿¡æ¯å‘é€åˆ°æ‚¨çš„é‚®ç®±: ${order.customer_email}`);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = 'æ”¯ä»˜æˆåŠŸ âœ…';
            usdtBtn.classList.remove('btn-success');
            usdtBtn.classList.add('btn-disabled');
        }

        // æ˜¾ç¤ºæ”¯ä»˜å¤±è´¥
        function showPaymentFailure(order) {
            alert(`âŒ æ”¯ä»˜å¤±è´¥\n\nè®¢å•å·: ${order.order_id}\nè¯·é‡æ–°å°è¯•æ”¯ä»˜æˆ–è”ç³»å®¢æœã€‚`);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = 'é‡æ–°æ”¯ä»˜';
        }

        // æ˜¾ç¤ºæ”¯ä»˜è¶…æ—¶
        function showPaymentTimeout(orderId) {
            alert(`â° æ”¯ä»˜çŠ¶æ€ç¡®è®¤è¶…æ—¶\n\nè®¢å•å·: ${orderId}\nå¦‚æœæ‚¨å·²å®Œæˆæ”¯ä»˜ï¼Œè¯·è”ç³»å®¢æœç¡®è®¤è®¢å•çŠ¶æ€ã€‚\næ”¯ä»˜å¯èƒ½ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚`);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = 'è”ç³»å®¢æœç¡®è®¤';
        }

        // å¤„ç†æ”¯ä»˜å®æ”¯ä»˜
        function processAlipayPayment() {
            // æ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç å¼¹çª—
            document.getElementById('qrcodeModal').style.display = 'flex';
        }

        // å…³é—­äºŒç»´ç å¼¹çª—
        function closeQRCodeModal() {
            document.getElementById('qrcodeModal').style.display = 'none';
        }

        // ä¿®æ”¹è®¢å•
        function editOrder() {
            document.getElementById('orderSummary').classList.remove('show');
            document.querySelector('.purchase-form').scrollIntoView({ behavior: 'smooth' });
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('qrcodeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQRCodeModal();
            }
        });

        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQRCodeModal();
            }
        });

        // æ˜¾ç¤ºå†…è”æ”¯ä»˜è¯¦æƒ…
        function showInlinePaymentDetails(orderId, payData) {
            console.log('ğŸ¯ æ˜¾ç¤ºæ”¯ä»˜è¯¦æƒ…:', payData);
            
            // å¡«å……æ”¯ä»˜ä¿¡æ¯
            document.getElementById('paymentOrderId').textContent = orderId;
            document.getElementById('paymentInvoiceId').textContent = payData.trackId || orderId;
            document.getElementById('paymentAmount').textContent = `${payData.payAmount || '0'} ${payData.payCurrency || 'USDT'}`;
            
            // å¤„ç†æ”¯ä»˜åœ°å€
            const addressInput = document.getElementById('paymentAddress');
            const copyBtn = document.querySelector('.copy-button');
            
            if (payData.payAddress) {
                // æœ‰æ”¯ä»˜åœ°å€ - æ ‡å‡†æµç¨‹
                addressInput.value = payData.payAddress;
                addressInput.placeholder = '';
                copyBtn.style.display = 'inline-block';
                console.log('âœ… æ”¯ä»˜åœ°å€å¯ç”¨:', payData.payAddress);
            } else {
                // æ— æ”¯ä»˜åœ°å€ - æ˜¾ç¤ºæç¤ºä¿¡æ¯
                addressInput.value = '';
                addressInput.placeholder = 'æ”¯ä»˜åœ°å€ç”Ÿæˆå¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹æ”¯ä»˜é“¾æ¥';
                addressInput.style.color = '#888';
                copyBtn.style.display = 'none';
                console.log('âš ï¸ æ”¯ä»˜åœ°å€ä¸å¯ç”¨');
            }
            
            // å¤„ç†äºŒç»´ç æ˜¾ç¤º
            const qrImg = document.getElementById('paymentQRCode');
            const qrLoading = document.getElementById('qrLoading');
            
            if (payData.qrCode) {
                // æœ‰äºŒç»´ç  - æ ‡å‡†æ˜¾ç¤º
                qrImg.src = payData.qrCode;
                qrImg.style.display = 'block';
                qrLoading.style.display = 'none';
                console.log('âœ… äºŒç»´ç å¯ç”¨');
            } else {
                // æ— äºŒç»´ç  - æ˜¾ç¤ºæ”¯ä»˜é“¾æ¥æˆ–åµŒå…¥æ”¯ä»˜é¡µé¢
                qrImg.style.display = 'none';
                
                if (payData.payLink) {
                    // åˆ›å»ºiframeåµŒå…¥æ”¯ä»˜é¡µé¢
                    qrLoading.innerHTML = `
                        <div class="payment-iframe-container">
                            <div class="iframe-header">
                                <i class="fas fa-shield-alt"></i> OxaPay å®‰å…¨æ”¯ä»˜é¡µé¢ - å¯ç›´æ¥åœ¨ä¸‹æ–¹å®Œæˆæ”¯ä»˜
                            </div>
                            <iframe 
                                id="paymentIframe"
                                src="${payData.payLink}" 
                                class="payment-iframe"
                                title="OxaPay æ”¯ä»˜é¡µé¢"
                                allow="payment; camera; microphone; encrypted-media; geolocation; clipboard-read; clipboard-write"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-top-navigation-by-user-activation allow-downloads allow-storage-access-by-user-activation"
                                onload="handleIframeLoad()"
                                onerror="handleIframeError()">
                            </iframe>
                            <div class="iframe-fallback" style="display: none;" id="iframeFallback">
                                <p style="color: #888; margin-bottom: 15px;">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    æ— æ³•åŠ è½½åµŒå…¥æ”¯ä»˜é¡µé¢
                                </p>
                                <button onclick="openPaymentPage('${payData.payLink}')" 
                                        class="payment-link-btn"
                                        style="
                                            background: linear-gradient(135deg, #00E5FF 0%, #0091EA 100%);
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 8px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
                                            transition: all 0.3s ease;
                                        "
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 229, 255, 0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 229, 255, 0.3)'">
                                    <i class="fas fa-external-link-alt"></i> åœ¨æ–°çª—å£æ‰“å¼€æ”¯ä»˜é¡µé¢
                                </button>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <button onclick="openPaymentPage('${payData.payLink}')" 
                                    class="btn btn-secondary" style="font-size: 12px; padding: 8px 15px;">
                                <i class="fas fa-external-link-alt"></i> åœ¨æ–°çª—å£æ‰“å¼€
                            </button>
                            <button onclick="refreshPaymentIframe()" 
                                    class="btn btn-secondary" style="font-size: 12px; padding: 8px 15px; margin-left: 10px;">
                                <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                            </button>
                        </div>
                        <div style="background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.3); 
                                   border-radius: 8px; padding: 15px; margin-top: 15px; text-align: center;">
                            <p style="color: #00E5FF; margin: 0; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> 
                                æ‚¨å¯ä»¥ç›´æ¥åœ¨ä¸Šæ–¹é¡µé¢ä¸­é€‰æ‹©æ”¯ä»˜æ–¹å¼å®Œæˆä»˜æ¬¾ï¼Œæ— éœ€è·³è½¬åˆ°å…¶ä»–çª—å£
                            </p>
                            <p style="color: #C0C0C0; margin: 5px 0 0 0; font-size: 12px;">
                                æ”¯ä»˜å®Œæˆåï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹"æ£€æŸ¥æ”¯ä»˜çŠ¶æ€"æŒ‰é’®ç¡®è®¤
                            </p>
                        </div>
                    `;
                    
                    // è°ƒæ•´å¸ƒå±€ä»¥é€‚åº”iframe
                    const qrSection = document.querySelector('.qr-code-section');
                    const qrContainer = document.querySelector('.qr-container');
                    if (qrSection) qrSection.classList.add('iframe-mode');
                    if (qrContainer) qrContainer.classList.add('iframe-container');
                    
                    console.log('ğŸ–¼ï¸ åµŒå…¥æ”¯ä»˜é¡µé¢iframe:', payData.payLink);
                } else {
                    // æ— äºŒç»´ç ä¹Ÿæ— æ”¯ä»˜é“¾æ¥
                    qrLoading.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: #f44336;"><i class="fas fa-times-circle"></i> æ”¯ä»˜é“¾æ¥ç”Ÿæˆå¤±è´¥</p>
                            <p style="color: #999; font-size: 14px;">è¯·è”ç³»å®¢æœè·å–å¸®åŠ©</p>
                        </div>
                    `;
                    console.log('âŒ æ— äºŒç»´ç ä¹Ÿæ— æ”¯ä»˜é“¾æ¥');
                }
            }
            
            // å¦‚æœåµŒå…¥äº†iframeï¼Œå¯åŠ¨è¶…æ—¶æ£€æµ‹
            if (payData.payLink && !payData.qrCode) {
                checkIframeLoadTimeout();
            }
            
            // æ·»åŠ è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (payData.warning) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 10px;
                    border-radius: 5px;
                    margin: 15px 0;
                    font-size: 14px;
                `;
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>æ³¨æ„:</strong> ${payData.warning}
                `;
                
                // æ’å…¥åˆ°æ”¯ä»˜è¯¦æƒ…åŒºåŸŸçš„å¼€å¤´
                const detailsSection = document.getElementById('paymentDetailsSection');
                const firstChild = detailsSection.querySelector('.payment-details-content');
                if (firstChild) {
                    firstChild.insertBefore(warningDiv, firstChild.firstChild);
                }
            }
            
            // è°ƒè¯•ä¿¡æ¯è¾“å‡º
            if (payData.debug) {
                console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:', payData.debug);
                console.log('ğŸ“‹ å¯ç”¨å­—æ®µ:', payData.debug.available_fields);
                console.log('âŒ ç¼ºå¤±å­—æ®µ:', payData.debug.missing_fields);
            }
            
            // æ˜¾ç¤ºæ”¯ä»˜è¯¦æƒ…åŒºåŸŸ
            document.getElementById('paymentDetailsSection').style.display = 'block';
            
            // æ»šåŠ¨åˆ°æ”¯ä»˜è¯¦æƒ…
            document.getElementById('paymentDetailsSection').scrollIntoView({ behavior: 'smooth' });
            
            // å­˜å‚¨å½“å‰è®¢å•IDç”¨äºçŠ¶æ€æ£€æŸ¥
            window.currentOrderId = orderId;
            window.currentPayData = payData; // å­˜å‚¨æ”¯ä»˜æ•°æ®ç”¨äºè°ƒè¯•
            
            console.log('âœ… æ”¯ä»˜è¯¦æƒ…æ˜¾ç¤ºå®Œæˆ');
        }
        
        // æ‰“å¼€æ”¯ä»˜é¡µé¢
        function openPaymentPage(payLink) {
            if (!payLink) {
                alert('æ”¯ä»˜é“¾æ¥æ— æ•ˆï¼Œè¯·è”ç³»å®¢æœ');
                return;
            }
            
            console.log('ğŸ”— æ‰“å¼€æ”¯ä»˜é“¾æ¥:', payLink);
            
            // åœ¨æ–°çª—å£æ‰“å¼€æ”¯ä»˜é¡µé¢
            const payWindow = window.open(payLink, '_blank', 'width=800,height=600,scrollbars=yes');
            
            if (!payWindow) {
                // å¦‚æœå¼¹çª—è¢«é˜»æ­¢ï¼Œå°è¯•ç›´æ¥è·³è½¬
                if (confirm('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œæ˜¯å¦åœ¨å½“å‰é¡µé¢è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼Ÿ\n\nå®Œæˆæ”¯ä»˜åè¯·è¿”å›æœ¬é¡µé¢ã€‚')) {
                    window.location.href = payLink;
                }
            } else {
                // ç›‘å¬æ”¯ä»˜çª—å£å…³é—­ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                const checkClosed = setInterval(() => {
                    if (payWindow.closed) {
                        clearInterval(checkClosed);
                        if (confirm('æ”¯ä»˜çª—å£å·²å…³é—­ã€‚\n\nå¦‚æœæ‚¨å·²å®Œæˆæ”¯ä»˜ï¼Œç‚¹å‡»"ç¡®å®š"æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ã€‚\nå¦‚æœè¿˜æœªæ”¯ä»˜ï¼Œç‚¹å‡»"å–æ¶ˆ"ç»§ç»­ã€‚')) {
                            checkInlinePaymentStatus();
                        }
                    }
                }, 1000);
            }
        }

        // æ£€æŸ¥å†…è”æ”¯ä»˜çŠ¶æ€
        async function checkInlinePaymentStatus() {
            if (!window.currentOrderId) {
                alert('æ²¡æœ‰æ‰¾åˆ°å½“å‰è®¢å•');
                return;
            }
            
            try {
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl}/order-status/${window.currentOrderId}`);
                const data = await response.json();
                
                if (data.success && data.order) {
                    const order = data.order;
                    const statusElement = document.getElementById('paymentStatus');
                    const statusIndicator = statusElement.querySelector('.status-indicator');
                    
                    if (order.payment_status === 'completed') {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #28a745;"></span>æ”¯ä»˜æˆåŠŸï¼';
                        alert(`ğŸ‰ æ”¯ä»˜æˆåŠŸï¼\n\nè®¢å•å·: ${order.order_id}\näº§å“: ${order.product_name} Ã— ${order.quantity}\næ€»ä»·: $${order.total_amount_usd} USDT\n\næˆ‘ä»¬ä¼šå°½å¿«å°†è´¦å·ä¿¡æ¯å‘é€åˆ°æ‚¨çš„é‚®ç®±: ${order.customer_email}`);
                        hidePaymentDetails();
                    } else if (order.payment_status === 'failed') {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #dc3545;"></span>æ”¯ä»˜å¤±è´¥';
                        alert('âŒ æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•æˆ–è”ç³»å®¢æœ');
                    } else {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #FFC107;"></span>ç­‰å¾…æ”¯ä»˜...';
                        alert('æ”¯ä»˜å°šæœªå®Œæˆï¼Œè¯·ç»§ç»­ç­‰å¾…æˆ–é‡æ–°æ£€æŸ¥');
                    }
                } else {
                    alert('æ— æ³•è·å–è®¢å•çŠ¶æ€ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€é”™è¯¯:', error);
                alert('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // éšè—æ”¯ä»˜è¯¦æƒ…
        function hidePaymentDetails() {
            document.getElementById('paymentDetailsSection').style.display = 'none';
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = 'å‰å¾€OxaPayæ”¯ä»˜';
            
            // æ¸…é™¤iframeç›¸å…³çš„CSSç±»
            const qrSection = document.querySelector('.qr-code-section');
            const qrContainer = document.querySelector('.qr-container');
            if (qrSection) qrSection.classList.remove('iframe-mode');
            if (qrContainer) qrContainer.classList.remove('iframe-container');
            
            // æ¸…é™¤è®¢å•ID
            window.currentOrderId = null;
            window.currentPayData = null;
        }

        // å¤åˆ¶æ”¯ä»˜åœ°å€
        function copyPaymentAddress() {
            const addressInput = document.getElementById('paymentAddress');
            if (addressInput.value) {
                navigator.clipboard.writeText(addressInput.value).then(() => {
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬
                    const copyBtn = document.querySelector('.copy-button');
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                    copyBtn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.background = '#00E5FF';
                    }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€');
                });
            }
        }

        // å¤„ç†iframeåŠ è½½æˆåŠŸ
        function handleIframeLoad() {
            console.log('âœ… æ”¯ä»˜é¡µé¢iframeåŠ è½½æˆåŠŸ');
            
            // éšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const loadingIndicator = document.getElementById('iframeLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›åŠ è½½æˆåŠŸçš„æç¤º
            const iframe = document.getElementById('paymentIframe');
            if (iframe) {
                // ç»™iframeæ·»åŠ ä¸€ä¸ªæˆåŠŸåŠ è½½çš„æ ‡è¯†
                iframe.setAttribute('data-loaded', 'true');
                
                // æ·»åŠ ä¸€ä¸ªsubtleçš„è§†è§‰æç¤ºè¡¨ç¤ºé¡µé¢å·²åŠ è½½
                iframe.style.opacity = '1';
                iframe.style.transition = 'opacity 0.3s ease';
            }
            
            // ç›‘å¬iframeå†…çš„æ”¯ä»˜å®Œæˆäº‹ä»¶ï¼ˆå¦‚æœOxaPayæ”¯æŒpostMessageï¼‰
            window.addEventListener('message', function(event) {
                // éªŒè¯æ¶ˆæ¯æ¥æº
                if (event.origin !== 'https://pay.oxapay.com') {
                    return;
                }
                
                console.log('æ”¶åˆ°iframeæ¶ˆæ¯:', event.data);
                
                // å¤„ç†æ”¯ä»˜å®Œæˆæ¶ˆæ¯
                if (event.data && event.data.type === 'payment_completed') {
                    console.log('ğŸ‰ iframeé€šçŸ¥æ”¯ä»˜å®Œæˆ');
                    setTimeout(() => {
                        checkInlinePaymentStatus();
                    }, 2000);
                }
            });
        }

        // å¤„ç†iframeåŠ è½½é”™è¯¯
        function handleIframeError() {
            console.error('âŒ æ”¯ä»˜é¡µé¢iframeåŠ è½½å¤±è´¥');
            
            // æ˜¾ç¤ºfallbacké€‰é¡¹
            const fallback = document.getElementById('iframeFallback');
            const iframe = document.getElementById('paymentIframe');
            
            if (fallback && iframe) {
                iframe.style.display = 'none';
                fallback.style.display = 'block';
            }
        }

        // æ£€æµ‹iframeæ˜¯å¦çœŸæ­£åŠ è½½æˆåŠŸï¼ˆè¶…æ—¶æ£€æµ‹ï¼‰
        function checkIframeLoadTimeout() {
            setTimeout(() => {
                const iframe = document.getElementById('paymentIframe');
                if (iframe && !iframe.getAttribute('data-loaded')) {
                    console.warn('âš ï¸ iframeåŠ è½½è¶…æ—¶ï¼Œæ˜¾ç¤ºfallback');
                    handleIframeError();
                }
            }, 10000); // 10ç§’è¶…æ—¶
        }

        // åˆ·æ–°iframeï¼ˆé‡æ–°åŠ è½½æ”¯ä»˜é¡µé¢ï¼‰
        function refreshPaymentIframe() {
            const iframe = document.getElementById('paymentIframe');
            if (iframe && window.currentPayData && window.currentPayData.payLink) {
                console.log('ğŸ”„ åˆ·æ–°æ”¯ä»˜é¡µé¢iframe');
                iframe.src = window.currentPayData.payLink + '?refresh=' + Date.now();
            }
        }
    </script>
</body>
</html> 