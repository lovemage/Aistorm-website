<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIStorm 商店 - 购买AI账号服务</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 继承网站主要样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0D0F12 0%, #101217 50%, #1A1D24 100%);
            color: #EAEAEA;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation Bar */
        .shop-nav {
            background: rgba(16, 18, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 229, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #00E5FF;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .nav-logo:hover {
            color: #00E5FF;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: #C0C0C0;
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            color: #00E5FF;
        }

        .nav-link.active {
            color: #00E5FF;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .shop-nav {
                position: sticky;
                top: 0;
            }
        }

        /* Header */
        .shop-header {
            background: rgba(16, 18, 23, 0.95);
            padding: 2rem 0;
            border-bottom: 2px solid #00E5FF;
            text-align: center;
            margin-bottom: 3rem;
        }

        .shop-header h1 {
            color: #00E5FF;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }

        .shop-header p {
            color: #C0C0C0;
            font-size: 1.1rem;
            margin: 0.5rem 0 0 0;
        }

        /* 购买表单 */
        .purchase-form {
            background: linear-gradient(145deg, #1A1D24, #101217);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 3rem;
            border: 1px solid rgba(0, 229, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .form-section {
            margin-bottom: 2.5rem;
        }

        .form-section h3 {
            color: #00E5FF;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #00E5FF;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* 产品选择 */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .product-option {
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .product-option:hover {
            border-color: rgba(0, 229, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 229, 255, 0.2);
        }

        .product-option.selected {
            border-color: #00E5FF;
            background: rgba(0, 229, 255, 0.1);
        }

        .product-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .product-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            transition: all 0.3s ease;
        }

        .product-option:hover .product-icon {
            border-color: rgba(0, 229, 255, 0.6);
            transform: scale(1.05);
        }

        .product-option.selected .product-icon {
            border-color: #00E5FF;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
        }

        .product-title {
            color: #D400FF;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: #B0B0B0;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .product-price {
            color: #39FF14;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .product-price-rmb {
            color: #00E5FF;
            font-size: 1rem;
        }

        /* 数量选择 */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .quantity-label {
            color: #C0C0C0;
            font-size: 1.1rem;
            min-width: 80px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            background: rgba(26, 29, 36, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 229, 255, 0.3);
        }

        .quantity-btn {
            background: transparent;
            border: none;
            color: #00E5FF;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .quantity-btn:hover {
            background: rgba(0, 229, 255, 0.2);
        }

        .quantity-btn:disabled {
            color: #666;
            cursor: not-allowed;
        }

        .quantity-input {
            background: transparent;
            border: none;
            color: #EAEAEA;
            text-align: center;
            width: 60px;
            height: 40px;
            font-size: 1.1rem;
        }

        /* 支付方式选择 */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .payment-option {
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .payment-option:hover {
            border-color: rgba(0, 229, 255, 0.5);
            transform: translateY(-3px);
        }

        .payment-option.selected {
            border-color: #00E5FF;
            background: rgba(0, 229, 255, 0.1);
        }

        .payment-option input[type="radio"] {
            display: none;
        }

        .payment-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .payment-option:hover .payment-icon {
            border-color: rgba(0, 229, 255, 0.6);
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
        }

        .payment-option.selected .payment-icon {
            border-color: #00E5FF;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
        }

        .usdt-icon {
            background-image: url('../assets/images/USDT.png');
            background-color: #26a17b;
        }

        .alipay-icon {
            background-image: url('../assets/images/alipay.png');
            background-color: #1677ff;
        }

        .payment-title {
            color: #D400FF;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .payment-description {
            color: #B0B0B0;
            font-size: 0.9rem;
        }

        /* 邮箱输入 */
        .email-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            background: rgba(26, 29, 36, 0.8);
            border: 2px solid rgba(0, 229, 255, 0.3);
            border-radius: 10px;
            color: #EAEAEA;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #00E5FF;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        .email-input::placeholder {
            color: #888;
        }

        /* 订单摘要 */
        .order-summary {
            background: linear-gradient(145deg, #101217, #1A1D24);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(212, 0, 255, 0.3);
            display: none;
        }

        .order-summary.show {
            display: block;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-title {
            color: #D400FF;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .summary-label {
            color: #C0C0C0;
        }

        .summary-value {
            color: #EAEAEA;
            font-weight: bold;
        }

        .total-amount {
            background: rgba(57, 255, 20, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            text-align: center;
            border: 1px solid #39FF14;
        }

        .total-usdt {
            color: #39FF14;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .total-rmb {
            color: #00E5FF;
            font-size: 1.2rem;
        }

        /* 按钮样式 */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00E5FF, #0AA6D8);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 229, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #39FF14, #2ECC40);
            color: #000;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(57, 255, 20, 0.4);
        }

        .btn-disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #666;
            color: #EAEAEA;
        }

        .btn-secondary:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 102, 102, 0.4);
        }

        /* 支付按钮区域 */
        .payment-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* 微信二维码弹窗 */
        .qrcode-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .qrcode-content {
            background: linear-gradient(145deg, #1A1D24, #101217);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #00E5FF;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
        }

        .qrcode-content h3 {
            color: #00E5FF;
            margin-bottom: 1.5rem;
        }

        .qrcode-content img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .purchase-form {
                padding: 2rem;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .payment-actions {
                flex-direction: column;
            }

            .shop-header h1 {
                font-size: 2rem;
            }
        }

        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 229, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00E5FF;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 产品图标 */
        .icon-chatgpt { background-image: url('../assets/images/chatgptpro.jpg'); }
        .icon-claude { background-image: url('../assets/images/claudemax.jpg'); }
        .icon-grok { background-image: url('../assets/images/grokpro.jpg'); }
        .icon-cursor { background-image: url('../assets/images/curserpro.jpeg'); }
        .icon-lovable { background-image: url('../assets/images/lovable.png'); }
        .icon-combo { background-image: url('../assets/images/logo.jpeg'); }
        
        /* 默认图标 */
        .icon-default {
            background: linear-gradient(135deg, #D400FF, #00E5FF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        /* 内联支付详情样式 */
        .payment-details-section {
            margin-top: 3rem;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-card {
            background: rgba(26, 29, 36, 0.6);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .info-card label {
            display: block;
            color: #C0C0C0;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .info-card span {
            color: #00E5FF;
            font-weight: bold;
            font-size: 1rem;
        }

        .qr-payment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .qr-code-section, .address-section {
            text-align: center;
        }

        /* 当显示iframe时，调整布局 */
        .qr-code-section.iframe-mode {
            grid-column: 1 / -1;
        }

        .qr-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        /* 当包含iframe时，移除背景和padding */
        .qr-container.iframe-container {
            background: transparent;
            padding: 0;
            min-height: auto;
        }

        .loading-placeholder {
            color: #666;
            text-align: center;
        }

        /* iframe 支付页面嵌入样式 */
        .payment-iframe-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(0, 229, 255, 0.3);
        }

        .payment-iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 8px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .iframe-header {
            background: linear-gradient(135deg, #00E5FF, #0091EA);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .iframe-fallback {
            text-align: center;
            padding: 20px;
            background: rgba(26, 29, 36, 0.8);
            border-radius: 10px;
            margin-top: 10px;
        }

        /* 移动端iframe适配 */
        @media (max-width: 768px) {
            .payment-iframe {
                height: 700px;
            }
            
            .qr-payment-container {
                grid-template-columns: 1fr;
            }
            
            .payment-iframe-container {
                grid-column: 1 / -1;
                margin-bottom: 1rem;
            }
        }

        .copy-button {
            background: #00E5FF;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .copy-button:hover {
            background: #00B8CC;
        }

        .payment-status {
            color: #FFC107;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .qr-payment-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .payment-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="shop-nav">
        <div class="nav-content">
            <a href="../index.html" class="nav-logo">
                <img src="../assets/images/logo.jpeg" alt="AIStorm Logo" style="width: 40px; height: 40px; border-radius: 8px;">
                AIStorm
            </a>
            <div class="nav-links">
                <a href="../index.html" class="nav-link">首页</a>
                <a href="shop.html" class="nav-link active">商店</a>
                <a href="#contact" class="nav-link">联系我们</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="shop-header">
        <div class="container">
            <h1>AIStorm 商店</h1>
            <p>选择您需要的AI账号服务，享受智能生活</p>
        </div>
    </header>

    <div class="container">
        <form class="purchase-form" id="purchaseForm">
            <!-- 步骤1: 选择产品 -->
            <div class="form-section">
                <h3>
                    <span class="step-number">1</span>
                    选择AI产品
                </h3>
                <div class="product-grid" id="productGrid">
                    <!-- 产品列表将通过JavaScript动态加载 -->
                    <div style="text-align: center; color: #666; grid-column: 1 / -1;">
                        <div class="loading"></div>
                        正在加载产品信息...
                    </div>
                </div>
            </div>

            <!-- 步骤2: 选择数量 -->
            <div class="form-section">
                <h3>
                    <span class="step-number">2</span>
                    选择购买数量
                </h3>
                <div class="quantity-selector">
                    <span class="quantity-label">数量:</span>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-btn" id="decreaseBtn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="5" readonly>
                        <button type="button" class="quantity-btn" id="increaseBtn" onclick="changeQuantity(1)">+</button>
                    </div>
                    <span style="color: #888; font-size: 0.9rem;">(最多5个)</span>
                </div>
            </div>

            <!-- 步骤3: 选择支付方式 -->
            <div class="form-section">
                <h3>
                    <span class="step-number">3</span>
                    选择支付方式
                </h3>
                <div class="payment-methods">
                    <label class="payment-option" for="usdt">
                        <input type="radio" id="usdt" name="paymentMethod" value="usdt">
                        <div class="payment-icon usdt-icon"></div>
                        <div class="payment-title">USDT 加密支付</div>
                        <div class="payment-description">Secure payment via Oxapay, generate Order.</div>
                    </label>
                    <label class="payment-option" for="alipay">
                        <input type="radio" id="alipay" name="paymentMethod" value="alipay">
                        <div class="payment-icon alipay-icon"></div>
                        <div class="payment-title">支付宝口令红包</div>
                        <div class="payment-description">微信扫码联系客服</div>
                    </label>
                </div>
            </div>

            <!-- 步骤4: 联系邮箱 -->
            <div class="form-section">
                <h3>
                    <span class="step-number">4</span>
                    联系邮箱
                </h3>
                <input type="email" class="email-input" id="emailInput" placeholder="请输入您的邮箱地址" required>
                <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">我们将通过此邮箱向您发送账号信息</p>
            </div>

            <!-- 提交按钮 -->
            <div style="text-align: center; margin-top: 2rem;">
                <button type="button" class="btn btn-primary" id="generateOrderBtn" onclick="generateOrder()">
                    生成订单
                </button>
            </div>
        </form>

        <!-- 订单摘要 -->
        <div class="order-summary" id="orderSummary">
            <h3 class="summary-title">订单摘要</h3>
            <div class="summary-item">
                <span class="summary-label">选择产品:</span>
                <span class="summary-value" id="summaryProduct">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">购买数量:</span>
                <span class="summary-value" id="summaryQuantity">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">支付方式:</span>
                <span class="summary-value" id="summaryPayment">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">联系邮箱:</span>
                <span class="summary-value" id="summaryEmail">-</span>
            </div>
            
            <div class="total-amount">
                <div class="total-usdt" id="totalUSDT">$0 USDT</div>
                <div class="total-rmb" id="totalRMB">≈ ¥0</div>
            </div>

            <div class="payment-actions">
                <button type="button" class="btn btn-success" id="usdtPayBtn" onclick="processUSDTPayment()" style="display: none;">
                    前往OxaPay支付
                </button>
                <button type="button" class="btn btn-success" id="alipayPayBtn" onclick="processAlipayPayment()" style="display: none;">
                    联系客服支付
                </button>
                <button type="button" class="btn btn-primary" onclick="editOrder()">
                    修改订单
                </button>
            </div>
        </div>
    </div>

    <!-- 内联支付详情区域 -->
    <div class="payment-details-section" id="paymentDetailsSection" style="display: none;">
        <div class="purchase-form">
            <h3 style="color: #00E5FF; text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-credit-card" style="margin-right: 10px;"></i>
                USDT 支付详情
            </h3>
            
            <!-- 订单信息 -->
            <div class="payment-info-grid" style="margin-bottom: 2rem;">
                <div class="info-card">
                    <label>订单号:</label>
                    <span id="paymentOrderId">-</span>
                </div>
                <div class="info-card">
                    <label>发票ID:</label>
                    <span id="paymentInvoiceId">-</span>
                </div>
                <div class="info-card">
                    <label>支付金额:</label>
                    <span id="paymentAmount">-</span>
                </div>
                <div class="info-card">
                    <label>支付网络:</label>
                    <span id="paymentNetwork">TRC20</span>
                </div>
            </div>

            <!-- 二维码和地址 -->
            <div class="qr-payment-container">
                <div class="qr-code-section">
                    <h4 style="color: #00E5FF; text-align: center;">扫描支付</h4>
                    <div class="qr-container">
                        <img id="paymentQRCode" src="" alt="支付二维码" style="max-width: 200px; width: 100%; border-radius: 10px; display: none;">
                        <div id="qrLoading" class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>正在生成支付二维码...</p>
                        </div>
                    </div>
                </div>
                
                <div class="address-section">
                    <h4 style="color: #00E5FF;">钱包地址</h4>
                    <div class="address-input-group">
                        <input type="text" id="paymentAddress" readonly placeholder="正在获取支付地址..." 
                               style="font-family: monospace; font-size: 0.9rem; background: rgba(26, 29, 36, 0.8); 
                                      border: 1px solid rgba(0, 229, 255, 0.3); color: #EAEAEA; padding: 10px; 
                                      border-radius: 8px; width: 100%; margin-bottom: 10px;">
                        <button onclick="copyPaymentAddress()" class="copy-button">
                            <i class="fas fa-copy"></i> 复制地址
                        </button>
                    </div>
                </div>
            </div>

            <!-- 支付说明 -->
            <div class="payment-instructions" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); 
                                                   border-radius: 10px; padding: 1.5rem; margin: 2rem 0;">
                <h5 style="color: #FFC107; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> 重要提醒
                </h5>
                <ul style="color: #C0C0C0; margin: 0; padding-left: 1.5rem;">
                    <li>请确保使用 <strong style="color: #00E5FF;">TRC20网络</strong> 转账USDT</li>
                    <li>转账金额必须 <strong style="color: #00E5FF;">完全匹配</strong> 上述显示金额</li>
                    <li>支付完成后约 <strong style="color: #00E5FF;">5分钟</strong> 自动确认</li>
                    <li>如遇问题请联系:</li>
                </ul>
                <div style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <div style="color: #C0C0C0; margin-bottom: 0.3rem;">
                        📱 人工客服Telegram: <strong style="color: #00E5FF;">@aistorm2025</strong>
                    </div>
                    <div style="color: #C0C0C0;">
                        💬 人工客服微信: <strong style="color: #00E5FF;">aistorm2024</strong>
                    </div>
                </div>
            </div>

            <!-- 支付状态和操作 -->
            <div class="payment-actions-inline" style="text-align: center;">
                <div class="payment-status" id="paymentStatus" style="margin-bottom: 1rem;">
                    <span class="status-indicator" style="display: inline-block; width: 12px; height: 12px; 
                                                        border-radius: 50%; background: #FFC107; margin-right: 8px;"></span>
                    等待支付...
                </div>
                <button onclick="checkInlinePaymentStatus()" class="btn btn-primary" style="margin-right: 10px;">
                    <i class="fas fa-sync"></i> 检查支付状态
                </button>
                <button onclick="hidePaymentDetails()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> 取消支付
                </button>
            </div>
        </div>
    </div>

    <!-- 微信二维码弹窗 -->
    <div class="qrcode-modal" id="qrcodeModal">
        <div class="qrcode-content">
            <h3>微信扫码联系客服</h3>
            <img src="../assets/images/wechat_qrcode.jpeg" alt="微信客服二维码" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: #888; padding: 2rem;">微信二维码图片加载失败<br>请直接添加微信: aistorm2024</div>
            <p style="color: #C0C0C0; margin: 1rem 0;">添加客服微信: <strong>aistorm2024</strong></p>
            <p style="color: #888; font-size: 0.9rem;">客服将协助您完成支付宝口令红包支付</p>
            <button class="close-modal" onclick="closeQRCodeModal()">关闭</button>
        </div>
    </div>

    <!-- 引入必要的JS文件 -->
    <script src="../assets/js/api-config.js"></script>
    
    <script>
        // 全局变量
        let products = [];
        let selectedProduct = null;
        let quantity = 1;
        let paymentMethod = null;
        let usdtToCnyRate = 8.0;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            initializeEventListeners();
        });

        // 加载产品数据
        async function loadProducts() {
            try {
                // 获取汇率设置
                await loadSiteSettings();
                
                // 加载产品
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl}/products`);
                
                if (response.ok) {
                    products = await response.json();
                    console.log('✅ 产品数据加载成功:', products);
                    renderProducts();
                } else {
                    throw new Error('API请求失败');
                }
            } catch (error) {
                console.error('❌ 加载产品失败:', error);
                // 使用静态数据作为后备
                products = getStaticProducts();
                renderProducts();
            }
        }

        // 加载站点设置获取汇率
        async function loadSiteSettings() {
            try {
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl.replace('/api', '')}/api/settings`);
                
                if (response.ok) {
                    const settings = await response.json();
                    if (settings.usdt_to_cny_rate) {
                        usdtToCnyRate = parseFloat(settings.usdt_to_cny_rate);
                        console.log('💱 获取汇率设置:', usdtToCnyRate);
                    }
                }
            } catch (error) {
                console.warn('⚠️ 获取汇率设置失败，使用默认汇率:', usdtToCnyRate);
            }
        }

        // 静态产品数据作为后备
        function getStaticProducts() {
            return [
                {
                    name: 'AI风暴组合套餐',
                    slug: 'ai-storm-combo',
                    short_description: 'ChatGPT Pro + Super Grok + Claude Max 5x 三合一超值套餐',
                    price_usd: 200,
                    price_unit: '月',
                    in_stock: true
                },
                {
                    name: 'ChatGPT Pro',
                    slug: 'chatgpt-pro',
                    short_description: 'OpenAI 官方 Pro 版本，无限制 GPT-4 Turbo',
                    price_usd: 130,
                    price_unit: '月',
                    in_stock: true
                },
                {
                    name: 'Claude Max 5x',
                    slug: 'claude-max-5x',
                    short_description: 'Anthropic Claude-3 Opus，5倍使用量',
                    price_usd: 75,
                    price_unit: '月',
                    in_stock: true
                },
                {
                    name: 'Super Grok',
                    slug: 'super-grok',
                    short_description: 'xAI 出品，X平台深度整合',
                    price_usd: 20,
                    price_unit: '月',
                    in_stock: true
                },
                {
                    name: 'Cursor Pro',
                    slug: 'cursor-pro',
                    short_description: 'AI-First Code Editor，GPT-4 Turbo 驱动',
                    price_usd: 12,
                    price_unit: '月',
                    in_stock: true
                },
                {
                    name: 'Lovable Pro 200 Credit',
                    slug: 'lovable-pro-200-credit',
                    short_description: 'AI 全栈应用开发平台，快速原型与部署',
                    price_usd: 35,
                    price_unit: '200 Credit',
                    in_stock: true
                }
            ];
        }

        // 渲染产品列表
        function renderProducts() {
            const productGrid = document.getElementById('productGrid');
            
            if (products.length === 0) {
                productGrid.innerHTML = '<div style="text-align: center; color: #888; grid-column: 1 / -1;">暂无可用产品</div>';
                return;
            }

            productGrid.innerHTML = products.map(product => {
                // 根据产品slug确定图标类
                let iconClass = 'icon-default';
                if (product.slug.includes('chatgpt')) iconClass = 'icon-chatgpt';
                else if (product.slug.includes('claude')) iconClass = 'icon-claude';
                else if (product.slug.includes('grok')) iconClass = 'icon-grok';
                else if (product.slug.includes('cursor')) iconClass = 'icon-cursor';
                else if (product.slug.includes('lovable')) iconClass = 'icon-lovable';
                else if (product.slug.includes('combo') || product.slug.includes('storm')) iconClass = 'icon-combo';
                
                // 如果是默认图标，显示产品名首字母
                const iconContent = iconClass === 'icon-default' ? 
                    `<div class="product-icon ${iconClass}">${product.name.charAt(0)}</div>` :
                    `<div class="product-icon ${iconClass}"></div>`;

                return `
                    <label class="product-option" for="product_${product.slug}">
                        <input type="radio" id="product_${product.slug}" name="product" value="${product.slug}" onchange="selectProduct('${product.slug}')">
                        ${iconContent}
                        <div class="product-title">${product.name}</div>
                        <div class="product-description">${product.short_description || product.description || ''}</div>
                        <div class="product-price">$${product.price_usd} USDT/${product.price_unit}</div>
                        <div class="product-price-rmb">≈ ¥${Math.round(product.price_usd * usdtToCnyRate)}/${product.price_unit}</div>
                        ${!product.in_stock ? '<div style="color: #FF5252; font-size: 0.9rem; margin-top: 0.5rem;">暂时缺货</div>' : ''}
                    </label>
                `;
            }).join('');
        }

        // 选择产品
        function selectProduct(slug) {
            selectedProduct = products.find(p => p.slug === slug);
            
            // 更新UI选中状态
            document.querySelectorAll('.product-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`label[for="product_${slug}"]`).classList.add('selected');
            
            console.log('选择产品:', selectedProduct);
        }

        // 修改数量
        function changeQuantity(delta) {
            const input = document.getElementById('quantityInput');
            const newValue = parseInt(input.value) + delta;
            
            if (newValue >= 1 && newValue <= 5) {
                input.value = newValue;
                quantity = newValue;
                
                // 更新按钮状态
                document.getElementById('decreaseBtn').disabled = newValue <= 1;
                document.getElementById('increaseBtn').disabled = newValue >= 5;
            }
        }

        // 初始化事件监听器
        function initializeEventListeners() {
            // 支付方式选择
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    paymentMethod = this.value;
                    
                    // 更新UI选中状态
                    document.querySelectorAll('.payment-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    this.closest('.payment-option').classList.add('selected');
                    
                    console.log('选择支付方式:', paymentMethod);
                });
            });

            // 数量输入框监听
            document.getElementById('quantityInput').addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value >= 1 && value <= 5) {
                    quantity = value;
                    document.getElementById('decreaseBtn').disabled = value <= 1;
                    document.getElementById('increaseBtn').disabled = value >= 5;
                }
            });
        }

        // 生成订单
        function generateOrder() {
            // 验证表单
            const email = document.getElementById('emailInput').value;
            
            if (!selectedProduct) {
                alert('请选择一个AI产品');
                return;
            }
            
            if (!paymentMethod) {
                alert('请选择支付方式');
                return;
            }
            
            if (!email || !isValidEmail(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }

            // 计算总价
            const totalUSDT = selectedProduct.price_usd * quantity;
            const totalRMB = Math.round(totalUSDT * usdtToCnyRate);

            // 更新订单摘要
            document.getElementById('summaryProduct').textContent = `${selectedProduct.name} × ${quantity}`;
            document.getElementById('summaryQuantity').textContent = `${quantity} 个`;
            document.getElementById('summaryPayment').textContent = paymentMethod === 'usdt' ? 'USDT支付' : '支付宝口令红包';
            document.getElementById('summaryEmail').textContent = email;
            document.getElementById('totalUSDT').textContent = `$${totalUSDT} USDT`;
            document.getElementById('totalRMB').textContent = `≈ ¥${totalRMB}`;

            // 显示对应的支付按钮
            document.getElementById('usdtPayBtn').style.display = paymentMethod === 'usdt' ? 'inline-block' : 'none';
            document.getElementById('alipayPayBtn').style.display = paymentMethod === 'alipay' ? 'inline-block' : 'none';

            // 显示订单摘要
            document.getElementById('orderSummary').classList.add('show');
            
            // 滚动到订单摘要
            document.getElementById('orderSummary').scrollIntoView({ behavior: 'smooth' });
        }

        // 验证邮箱格式
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // 处理USDT支付
        function processUSDTPayment() {
            // 禁用按钮，防止重复点击
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = true;
            usdtBtn.innerHTML = '<div class="loading"></div>处理中...';
            
            createOrderAndPay();
        }

        // 创建订单并处理支付
        async function createOrderAndPay() {
            try {
                const email = document.getElementById('emailInput').value;
                
                console.log('🚀 开始创建订单...', {
                    product: selectedProduct.slug,
                    quantity: quantity,
                    email: email
                });
                
                // 第一步：创建订单
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const orderPayload = {
                    customer_email: email,
                    product_slug: selectedProduct.slug,
                    quantity: quantity
                };
                
                console.log('📤 发送订单数据:', orderPayload);
                
                const createOrderResponse = await fetch(`${apiBaseUrl}/create-order`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(orderPayload)
                });
                
                console.log('📥 订单创建响应状态:', createOrderResponse.status);
                
                if (!createOrderResponse.ok) {
                    const errorText = await createOrderResponse.text();
                    console.error('❌ 订单创建失败响应:', errorText);
                    
                    // 尝试解析JSON错误
                    let errorMessage = `订单创建失败 (${createOrderResponse.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // 如果不是JSON，使用原始文本
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const orderData = await createOrderResponse.json();
                console.log('✅ 订单创建响应数据:', orderData);
                
                if (!orderData.success) {
                    throw new Error(orderData.error || '创建订单失败');
                }
                
                console.log('✅ 订单创建成功:', orderData);
                
                // 使用后端返回的订单ID
                const finalOrderId = orderData.order_id;
                
                // 第二步：生成OxaPay支付链接
                const paymentPayload = {
                    orderId: finalOrderId
                };
                
                console.log('📤 发送支付请求:', paymentPayload);
                
                const oxapayResponse = await fetch(`${apiBaseUrl}/oxapay-payment`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(paymentPayload)
                });
                
                console.log('📥 支付响应状态:', oxapayResponse.status);
                
                if (!oxapayResponse.ok) {
                    const errorText = await oxapayResponse.text();
                    console.error('❌ 支付请求失败响应:', errorText);
                    
                    // 尝试解析JSON错误
                    let errorMessage = `支付请求失败 (${oxapayResponse.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // 如果不是JSON，使用原始文本
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const payData = await oxapayResponse.json();
                console.log('✅ 支付响应数据:', payData);
                
                if (!payData.success) {
                    // 改进错误处理：为常见错误提供更友好的提示
                    let userFriendlyError = payData.error || '生成支付链接失败';
                    
                    // 如果是API密钥相关错误，但在开发环境中，提供更友好的提示
                    if (userFriendlyError.includes('API密钥未配置') || userFriendlyError.includes('密钥无效')) {
                        userFriendlyError = '支付服务暂时不可用，请稍后重试或联系客服';
                    }
                    
                    throw new Error(userFriendlyError);
                }
                
                console.log('✅ 支付链接生成成功:', payData);
                
                // 第三步：显示内联支付详情（而不是跳转页面）
                if (payData.payLink || payData.qrCode || payData.payAddress) {
                    // 显示支付成功创建的提示
                    alert(`订单创建成功！\n订单号: ${finalOrderId}\n请在下方完成USDT支付。`);
                    
                    // 显示内联支付详情
                    showInlinePaymentDetails(finalOrderId, payData);
                    
                    // 启动订单状态轮询
                    startOrderStatusPolling(finalOrderId);
                } else {
                    throw new Error('支付链接生成失败');
                }
                
            } catch (error) {
                console.error('❌ 支付处理错误:', error);
                alert(`支付处理失败: ${error.message}\n\n请稍后重试或联系客服。`);
                
                // 恢复按钮状态
                const usdtBtn = document.getElementById('usdtPayBtn');
                usdtBtn.disabled = false;
                usdtBtn.innerHTML = '前往OxaPay支付';
            }
        }

        // 轮询订单状态
        function startOrderStatusPolling(orderId) {
            const maxAttempts = 30; // 最多轮询30次（5分钟）
            let attempts = 0;
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                    const response = await fetch(`${apiBaseUrl}/order-status/${orderId}`);
                    const data = await response.json();
                    
                    if (data.success && data.order) {
                        const order = data.order;
                        
                        if (order.payment_status === 'completed') {
                            clearInterval(pollInterval);
                            showPaymentSuccess(order);
                            return;
                        } else if (order.payment_status === 'failed') {
                            clearInterval(pollInterval);
                            showPaymentFailure(order);
                            return;
                        }
                    }
                    
                    // 更新按钮状态显示轮询进度
                    const usdtBtn = document.getElementById('usdtPayBtn');
                    usdtBtn.innerHTML = `<div class="loading"></div>等待支付确认 (${attempts}/${maxAttempts})`;
                    
                } catch (error) {
                    console.error('轮询订单状态错误:', error);
                }
                
                // 达到最大尝试次数
                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    showPaymentTimeout(orderId);
                }
            }, 10000); // 每10秒轮询一次
        }

        // 显示支付成功
        function showPaymentSuccess(order) {
            alert(`🎉 支付成功！\n\n订单号: ${order.order_id}\n产品: ${order.product_name} × ${order.quantity}\n总价: $${order.total_amount_usd} USDT\n\n我们会尽快将账号信息发送到您的邮箱: ${order.customer_email}`);
            
            // 恢复按钮状态
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = '支付成功 ✅';
            usdtBtn.classList.remove('btn-success');
            usdtBtn.classList.add('btn-disabled');
        }

        // 显示支付失败
        function showPaymentFailure(order) {
            alert(`❌ 支付失败\n\n订单号: ${order.order_id}\n请重新尝试支付或联系客服。`);
            
            // 恢复按钮状态
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = '重新支付';
        }

        // 显示支付超时
        function showPaymentTimeout(orderId) {
            alert(`⏰ 支付状态确认超时\n\n订单号: ${orderId}\n如果您已完成支付，请联系客服确认订单状态。\n支付可能仍在处理中，请耐心等待。`);
            
            // 恢复按钮状态
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = '联系客服确认';
        }

        // 处理支付宝支付
        function processAlipayPayment() {
            // 显示微信二维码弹窗
            document.getElementById('qrcodeModal').style.display = 'flex';
        }

        // 关闭二维码弹窗
        function closeQRCodeModal() {
            document.getElementById('qrcodeModal').style.display = 'none';
        }

        // 修改订单
        function editOrder() {
            document.getElementById('orderSummary').classList.remove('show');
            document.querySelector('.purchase-form').scrollIntoView({ behavior: 'smooth' });
        }

        // 点击弹窗外部关闭
        document.getElementById('qrcodeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQRCodeModal();
            }
        });

        // ESC键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQRCodeModal();
            }
        });

        // 显示内联支付详情
        function showInlinePaymentDetails(orderId, payData) {
            console.log('🎯 显示支付详情:', payData);
            
            // 填充支付信息
            document.getElementById('paymentOrderId').textContent = orderId;
            document.getElementById('paymentInvoiceId').textContent = payData.trackId || orderId;
            document.getElementById('paymentAmount').textContent = `${payData.payAmount || '0'} ${payData.payCurrency || 'USDT'}`;
            
            // 处理支付地址
            const addressInput = document.getElementById('paymentAddress');
            const copyBtn = document.querySelector('.copy-button');
            
            if (payData.payAddress) {
                // 有支付地址 - 标准流程
                addressInput.value = payData.payAddress;
                addressInput.placeholder = '';
                copyBtn.style.display = 'inline-block';
                console.log('✅ 支付地址可用:', payData.payAddress);
            } else {
                // 无支付地址 - 显示提示信息
                addressInput.value = '';
                addressInput.placeholder = '支付地址生成失败，请使用下方支付链接';
                addressInput.style.color = '#888';
                copyBtn.style.display = 'none';
                console.log('⚠️ 支付地址不可用');
            }
            
            // 处理二维码显示
            const qrImg = document.getElementById('paymentQRCode');
            const qrLoading = document.getElementById('qrLoading');
            
            if (payData.qrCode) {
                // 有二维码 - 标准显示
                qrImg.src = payData.qrCode;
                qrImg.style.display = 'block';
                qrLoading.style.display = 'none';
                console.log('✅ 二维码可用');
            } else {
                // 无二维码 - 显示支付链接或嵌入支付页面
                qrImg.style.display = 'none';
                
                if (payData.payLink) {
                    // 创建iframe嵌入支付页面
                    qrLoading.innerHTML = `
                        <div class="payment-iframe-container">
                            <div class="iframe-header">
                                <i class="fas fa-shield-alt"></i> OxaPay 安全支付页面 - 可直接在下方完成支付
                            </div>
                            <iframe 
                                id="paymentIframe"
                                src="${payData.payLink}" 
                                class="payment-iframe"
                                title="OxaPay 支付页面"
                                allow="payment; camera; microphone; encrypted-media; geolocation; clipboard-read; clipboard-write"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-top-navigation-by-user-activation allow-downloads allow-storage-access-by-user-activation"
                                onload="handleIframeLoad()"
                                onerror="handleIframeError()">
                            </iframe>
                            <div class="iframe-fallback" style="display: none;" id="iframeFallback">
                                <p style="color: #888; margin-bottom: 15px;">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    无法加载嵌入支付页面
                                </p>
                                <button onclick="openPaymentPage('${payData.payLink}')" 
                                        class="payment-link-btn"
                                        style="
                                            background: linear-gradient(135deg, #00E5FF 0%, #0091EA 100%);
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 8px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
                                            transition: all 0.3s ease;
                                        "
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 229, 255, 0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 229, 255, 0.3)'">
                                    <i class="fas fa-external-link-alt"></i> 在新窗口打开支付页面
                                </button>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <button onclick="openPaymentPage('${payData.payLink}')" 
                                    class="btn btn-secondary" style="font-size: 12px; padding: 8px 15px;">
                                <i class="fas fa-external-link-alt"></i> 在新窗口打开
                            </button>
                            <button onclick="refreshPaymentIframe()" 
                                    class="btn btn-secondary" style="font-size: 12px; padding: 8px 15px; margin-left: 10px;">
                                <i class="fas fa-sync"></i> 刷新页面
                            </button>
                        </div>
                        <div style="background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.3); 
                                   border-radius: 8px; padding: 15px; margin-top: 15px; text-align: center;">
                            <p style="color: #00E5FF; margin: 0; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> 
                                您可以直接在上方页面中选择支付方式完成付款，无需跳转到其他窗口
                            </p>
                            <p style="color: #C0C0C0; margin: 5px 0 0 0; font-size: 12px;">
                                支付完成后，请点击下方"检查支付状态"按钮确认
                            </p>
                        </div>
                    `;
                    
                    // 调整布局以适应iframe
                    const qrSection = document.querySelector('.qr-code-section');
                    const qrContainer = document.querySelector('.qr-container');
                    if (qrSection) qrSection.classList.add('iframe-mode');
                    if (qrContainer) qrContainer.classList.add('iframe-container');
                    
                    console.log('🖼️ 嵌入支付页面iframe:', payData.payLink);
                } else {
                    // 无二维码也无支付链接
                    qrLoading.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: #f44336;"><i class="fas fa-times-circle"></i> 支付链接生成失败</p>
                            <p style="color: #999; font-size: 14px;">请联系客服获取帮助</p>
                        </div>
                    `;
                    console.log('❌ 无二维码也无支付链接');
                }
            }
            
            // 如果嵌入了iframe，启动超时检测
            if (payData.payLink && !payData.qrCode) {
                checkIframeLoadTimeout();
            }
            
            // 添加警告信息（如果有）
            if (payData.warning) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 10px;
                    border-radius: 5px;
                    margin: 15px 0;
                    font-size: 14px;
                `;
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>注意:</strong> ${payData.warning}
                `;
                
                // 插入到支付详情区域的开头
                const detailsSection = document.getElementById('paymentDetailsSection');
                const firstChild = detailsSection.querySelector('.payment-details-content');
                if (firstChild) {
                    firstChild.insertBefore(warningDiv, firstChild.firstChild);
                }
            }
            
            // 调试信息输出
            if (payData.debug) {
                console.log('🔍 调试信息:', payData.debug);
                console.log('📋 可用字段:', payData.debug.available_fields);
                console.log('❌ 缺失字段:', payData.debug.missing_fields);
            }
            
            // 显示支付详情区域
            document.getElementById('paymentDetailsSection').style.display = 'block';
            
            // 滚动到支付详情
            document.getElementById('paymentDetailsSection').scrollIntoView({ behavior: 'smooth' });
            
            // 存储当前订单ID用于状态检查
            window.currentOrderId = orderId;
            window.currentPayData = payData; // 存储支付数据用于调试
            
            console.log('✅ 支付详情显示完成');
        }
        
        // 打开支付页面
        function openPaymentPage(payLink) {
            if (!payLink) {
                alert('支付链接无效，请联系客服');
                return;
            }
            
            console.log('🔗 打开支付链接:', payLink);
            
            // 在新窗口打开支付页面
            const payWindow = window.open(payLink, '_blank', 'width=800,height=600,scrollbars=yes');
            
            if (!payWindow) {
                // 如果弹窗被阻止，尝试直接跳转
                if (confirm('无法打开新窗口，是否在当前页面跳转到支付页面？\n\n完成支付后请返回本页面。')) {
                    window.location.href = payLink;
                }
            } else {
                // 监听支付窗口关闭，提示用户检查支付状态
                const checkClosed = setInterval(() => {
                    if (payWindow.closed) {
                        clearInterval(checkClosed);
                        if (confirm('支付窗口已关闭。\n\n如果您已完成支付，点击"确定"检查支付状态。\n如果还未支付，点击"取消"继续。')) {
                            checkInlinePaymentStatus();
                        }
                    }
                }, 1000);
            }
        }

        // 检查内联支付状态
        async function checkInlinePaymentStatus() {
            if (!window.currentOrderId) {
                alert('没有找到当前订单');
                return;
            }
            
            try {
                const apiBaseUrl = window.apiConfig ? window.apiConfig.getBaseUrl() : '/api';
                const response = await fetch(`${apiBaseUrl}/order-status/${window.currentOrderId}`);
                const data = await response.json();
                
                if (data.success && data.order) {
                    const order = data.order;
                    const statusElement = document.getElementById('paymentStatus');
                    const statusIndicator = statusElement.querySelector('.status-indicator');
                    
                    if (order.payment_status === 'completed') {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #28a745;"></span>支付成功！';
                        alert(`🎉 支付成功！\n\n订单号: ${order.order_id}\n产品: ${order.product_name} × ${order.quantity}\n总价: $${order.total_amount_usd} USDT\n\n我们会尽快将账号信息发送到您的邮箱: ${order.customer_email}`);
                        hidePaymentDetails();
                    } else if (order.payment_status === 'failed') {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #dc3545;"></span>支付失败';
                        alert('❌ 支付失败，请重新尝试或联系客服');
                    } else {
                        statusElement.innerHTML = '<span class="status-indicator" style="background: #FFC107;"></span>等待支付...';
                        alert('支付尚未完成，请继续等待或重新检查');
                    }
                } else {
                    alert('无法获取订单状态，请稍后重试');
                }
            } catch (error) {
                console.error('检查支付状态错误:', error);
                alert('检查支付状态失败，请稍后重试');
            }
        }

        // 隐藏支付详情
        function hidePaymentDetails() {
            document.getElementById('paymentDetailsSection').style.display = 'none';
            
            // 恢复按钮状态
            const usdtBtn = document.getElementById('usdtPayBtn');
            usdtBtn.disabled = false;
            usdtBtn.innerHTML = '前往OxaPay支付';
            
            // 清除iframe相关的CSS类
            const qrSection = document.querySelector('.qr-code-section');
            const qrContainer = document.querySelector('.qr-container');
            if (qrSection) qrSection.classList.remove('iframe-mode');
            if (qrContainer) qrContainer.classList.remove('iframe-container');
            
            // 清除订单ID
            window.currentOrderId = null;
            window.currentPayData = null;
        }

        // 复制支付地址
        function copyPaymentAddress() {
            const addressInput = document.getElementById('paymentAddress');
            if (addressInput.value) {
                navigator.clipboard.writeText(addressInput.value).then(() => {
                    // 临时改变按钮文本
                    const copyBtn = document.querySelector('.copy-button');
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                    copyBtn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.background = '#00E5FF';
                    }, 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动复制地址');
                });
            }
        }

        // 处理iframe加载成功
        function handleIframeLoad() {
            console.log('✅ 支付页面iframe加载成功');
            
            // 隐藏加载指示器（如果有的话）
            const loadingIndicator = document.getElementById('iframeLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // 可以在这里添加一些加载成功的提示
            const iframe = document.getElementById('paymentIframe');
            if (iframe) {
                // 给iframe添加一个成功加载的标识
                iframe.setAttribute('data-loaded', 'true');
                
                // 添加一个subtle的视觉提示表示页面已加载
                iframe.style.opacity = '1';
                iframe.style.transition = 'opacity 0.3s ease';
            }
            
            // 监听iframe内的支付完成事件（如果OxaPay支持postMessage）
            window.addEventListener('message', function(event) {
                // 验证消息来源
                if (event.origin !== 'https://pay.oxapay.com') {
                    return;
                }
                
                console.log('收到iframe消息:', event.data);
                
                // 处理支付完成消息
                if (event.data && event.data.type === 'payment_completed') {
                    console.log('🎉 iframe通知支付完成');
                    setTimeout(() => {
                        checkInlinePaymentStatus();
                    }, 2000);
                }
            });
        }

        // 处理iframe加载错误
        function handleIframeError() {
            console.error('❌ 支付页面iframe加载失败');
            
            // 显示fallback选项
            const fallback = document.getElementById('iframeFallback');
            const iframe = document.getElementById('paymentIframe');
            
            if (fallback && iframe) {
                iframe.style.display = 'none';
                fallback.style.display = 'block';
            }
        }

        // 检测iframe是否真正加载成功（超时检测）
        function checkIframeLoadTimeout() {
            setTimeout(() => {
                const iframe = document.getElementById('paymentIframe');
                if (iframe && !iframe.getAttribute('data-loaded')) {
                    console.warn('⚠️ iframe加载超时，显示fallback');
                    handleIframeError();
                }
            }, 10000); // 10秒超时
        }

        // 刷新iframe（重新加载支付页面）
        function refreshPaymentIframe() {
            const iframe = document.getElementById('paymentIframe');
            if (iframe && window.currentPayData && window.currentPayData.payLink) {
                console.log('🔄 刷新支付页面iframe');
                iframe.src = window.currentPayData.payLink + '?refresh=' + Date.now();
            }
        }
    </script>
</body>
</html> 