<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT支付 - AIStorm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .payment-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .qr-code-container {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        .qr-code-image {
            max-width: 250px;
            width: 100%;
            height: auto;
        }
        .payment-address {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            border: 2px dashed #007bff;
        }
        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
        }
        .payment-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background: #0056b3;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending {
            background: #ffc107;
            animation: pulse 2s infinite;
        }
        .status-confirmed {
            background: #28a745;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div class="container">
        <div class="payment-container">
            <div class="text-center mb-4">
                <h2><i class="fas fa-wallet text-primary"></i> USDT支付</h2>
                <p class="text-muted">请使用USDT钱包扫描二维码或转账到指定地址</p>
            </div>

            <!-- 订单信息 -->
            <div class="payment-info">
                <h5><i class="fas fa-shopping-cart"></i> 订单信息</h5>
                <div class="row">
                    <div class="col-sm-6">
                        <strong>订单号：</strong><span id="order-id">加载中...</span>
                    </div>
                    <div class="col-sm-6">
                        <strong>产品：</strong><span id="product-name">加载中...</span>
                    </div>
                    <div class="col-sm-6 mt-2">
                        <strong>金额：</strong><span id="usd-amount">加载中...</span> USD
                    </div>
                    <div class="col-sm-6 mt-2">
                        <strong>支付：</strong><span id="pay-amount">加载中...</span> <span id="pay-currency">USDT</span>
                    </div>
                </div>
            </div>

            <!-- 支付状态 -->
            <div class="text-center mb-3">
                <h5>
                    <span class="status-indicator status-pending" id="status-indicator"></span>
                    <span id="payment-status">等待支付</span>
                </h5>
                <div class="countdown" id="countdown">15:00</div>
                <small class="text-muted">支付剩余时间</small>
            </div>

            <!-- QR码 -->
            <div class="qr-code-container">
                <img id="qr-code" src="" alt="支付二维码" class="qr-code-image" style="display: none;">
                <div id="qr-loading">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">正在生成支付二维码...</p>
                </div>
            </div>

            <!-- 支付地址 -->
            <div class="mb-4">
                <label class="form-label"><strong><i class="fas fa-link"></i> 支付地址 (TRC20网络)</strong></label>
                <div class="input-group">
                    <input type="text" class="form-control payment-address" id="payment-address" readonly placeholder="正在获取支付地址...">
                    <button class="copy-btn" onclick="copyAddress()">
                        <i class="fas fa-copy"></i> 复制
                    </button>
                </div>
            </div>

            <!-- 支付说明 -->
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> 重要提醒：</h6>
                <ul class="mb-0">
                    <li>请确保使用 <strong>TRC20网络</strong> 转账USDT</li>
                    <li>转账金额必须 <strong>完全匹配</strong> 上述金额</li>
                    <li>支付完成后将自动确认，请勿重复支付</li>
                    <li>如有问题请联系客服</li>
                </ul>
            </div>

            <!-- 操作按钮 -->
            <div class="text-center">
                <button class="btn btn-primary btn-lg me-2" onclick="checkPaymentStatus()">
                    <i class="fas fa-sync"></i> 检查支付状态
                </button>
                <button class="btn btn-outline-secondary" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let paymentData = {};
        let countdownInterval;
        let statusCheckInterval;

        // 从URL参数获取支付信息
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                orderId: params.get('order'),
                trackId: params.get('track'),
                payAddress: params.get('address'),
                payAmount: params.get('amount'),
                payCurrency: params.get('currency'),
                qrCode: params.get('qr')
            };
        }

        // 初始化页面
        function initPaymentPage() {
            const params = getUrlParams();
            
            if (!params.orderId) {
                alert('无效的支付链接');
                window.location.href = '/';
                return;
            }

            // 显示订单信息
            document.getElementById('order-id').textContent = params.orderId;
            document.getElementById('pay-amount').textContent = params.payAmount;
            document.getElementById('pay-currency').textContent = params.payCurrency;

            // 显示支付地址
            if (params.payAddress) {
                document.getElementById('payment-address').value = params.payAddress;
            }

            // 显示QR码
            if (params.qrCode) {
                const qrImg = document.getElementById('qr-code');
                qrImg.src = decodeURIComponent(params.qrCode);
                qrImg.style.display = 'block';
                document.getElementById('qr-loading').style.display = 'none';
            }

            // 获取完整订单信息
            fetchOrderDetails(params.orderId);

            // 开始倒计时
            startCountdown(15 * 60); // 15分钟

            // 开始定期检查支付状态
            statusCheckInterval = setInterval(() => {
                checkPaymentStatus();
            }, 10000); // 每10秒检查一次
        }

        // 获取订单详情
        async function fetchOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/order-status/${orderId}`);
                const data = await response.json();
                
                if (data.success) {
                    const order = data.order;
                    document.getElementById('product-name').textContent = order.product_name;
                    document.getElementById('usd-amount').textContent = order.total_amount_usd;
                }
            } catch (error) {
                console.error('获取订单详情失败:', error);
            }
        }

        // 开始倒计时
        function startCountdown(seconds) {
            const countdownElement = document.getElementById('countdown');
            
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownElement.textContent = '已过期';
                    countdownElement.className = 'countdown text-danger';
                    
                    // 停止状态检查
                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                    }
                    
                    alert('支付已超时，请重新创建订单');
                    return;
                }
                
                seconds--;
            }, 1000);
        }

        // 复制支付地址
        function copyAddress() {
            const addressInput = document.getElementById('payment-address');
            addressInput.select();
            document.execCommand('copy');
            
            // 显示复制成功提示
            const btn = event.target.closest('.copy-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '#007bff';
            }, 2000);
        }

        // 检查支付状态
        async function checkPaymentStatus() {
            const params = getUrlParams();
            
            try {
                const response = await fetch(`/api/order-status/${params.orderId}`);
                const data = await response.json();
                
                if (data.success && data.order) {
                    const order = data.order;
                    const statusElement = document.getElementById('payment-status');
                    const indicatorElement = document.getElementById('status-indicator');
                    
                    if (order.payment_status === 'completed') {
                        statusElement.textContent = '支付成功';
                        indicatorElement.className = 'status-indicator status-confirmed';
                        
                        // 停止倒计时和状态检查
                        if (countdownInterval) clearInterval(countdownInterval);
                        if (statusCheckInterval) clearInterval(statusCheckInterval);
                        
                        // 3秒后跳转到成功页面
                        setTimeout(() => {
                            window.location.href = `/payment-success.html?order=${params.orderId}`;
                        }, 3000);
                        
                        alert('支付成功！即将跳转到成功页面...');
                    }
                }
            } catch (error) {
                console.error('检查支付状态失败:', error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPaymentPage);

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', () => {
            if (countdownInterval) clearInterval(countdownInterval);
            if (statusCheckInterval) clearInterval(statusCheckInterval);
        });
    </script>
</body>
</html> 